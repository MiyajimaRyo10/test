<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edu-ARG Builder Studio v3.23 AI ICE Designer</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f3f4f6;
            height: 100vh;
            overflow: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        .phone-frame {
            width: 375px;
            height: 667px;
            border: 12px solid #1e293b;
            border-radius: 36px;
            overflow: hidden;
            position: relative;
            background: white;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .phone-notch {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 24px;
            background: #1e293b;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            z-index: 50;
        }

        .step-active {
            background-color: #e0e7ff;
            color: #4338ca;
            border-right: 3px solid #4338ca;
        }

        /* Drag & Drop Styles */
        .draggable-item {
            transition: all 0.2s ease;
        }
        .draggable-item.dragging {
            opacity: 0.5;
            border: 2px dashed #6366f1;
        }
        .draggable-item.drag-over {
            border-top: 2px solid #4f46e5;
            transform: translateY(2px);
        }
        
        /* Paper Preview Styles */
        .a4-paper {
            width: 210mm;
            height: 297mm;
            background: white;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            padding: 15mm;
            margin-bottom: 20px;
            font-size: 11pt;
            line-height: 1.6;
            color: #333;
            transform-origin: top center;
            position: relative;
        }
        .a4-paper h1 { font-size: 24pt; font-weight: bold; margin-bottom: 10mm; text-align: center; border-bottom: 2px solid #333; padding-bottom: 5mm; }
        .a4-paper h2 { font-size: 16pt; font-weight: bold; margin-top: 8mm; margin-bottom: 4mm; border-left: 5px solid #6366f1; padding-left: 3mm; }
        .a4-paper h3 { font-size: 12pt; font-weight: bold; margin-top: 5mm; margin-bottom: 2mm; }
        .a4-paper p { margin-bottom: 4mm; text-align: justify; }
        .a4-paper ul { list-style-type: disc; padding-left: 5mm; margin-bottom: 4mm; }
        .rubric-table { width: 100%; border-collapse: collapse; margin-top: 5mm; font-size: 9pt; }
        .rubric-table th, .rubric-table td { border: 1px solid #999; padding: 2mm; }
        .rubric-table th { background-color: #f0f0f0; text-align: center; }

        /* Dark Mode Paper Styles */
        .a4-paper.dark-mode {
            background-color: #0f172a; /* slate-900 */
            color: #e2e8f0; /* slate-200 */
        }
        .a4-paper.dark-mode h1 {
            border-bottom-color: #e2e8f0;
        }
        .a4-paper.dark-mode h2 {
            border-left-color: #818cf8; /* indigo-400 */
        }
        .a4-paper.dark-mode .qr-container {
            background-color: white;
            padding: 10px;
            border: 4px solid #e2e8f0;
        }
        .a4-paper.dark-mode .mission-box {
            background-color: #1e293b; /* slate-800 */
            border-left-color: #818cf8;
            color: #e2e8f0;
        }
        .a4-paper.dark-mode .footer {
            border-top-color: #475569;
            color: #64748b;
        }
        
        /* Loading Overlay */
        #ai-loading-overlay {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(4px);
        }

    </style>
</head>
<body class="flex h-screen text-slate-800">

    <!-- Left Sidebar: Navigation -->
    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col z-10 shadow-sm">
        <div class="p-6 border-b border-slate-100">
            <h1 class="text-xl font-bold text-indigo-600 flex items-center gap-2">
                <i data-lucide="box"></i> ARG Builder
            </h1>
            <p class="text-xs text-slate-400 mt-1">Educational Game Engine</p>
        </div>
        <nav class="flex-1 overflow-y-auto py-4" id="step-nav">
            <!-- Dynamic Nav Items -->
        </nav>
        <div class="p-4 border-t border-slate-100 text-xs text-center text-slate-400">
            v3.23.0 AI ICE Designer
        </div>
    </aside>

    <!-- Center: Main Editor Area -->
    <main class="flex-1 flex flex-col min-w-0 bg-slate-50 relative">
        <header class="bg-white border-b border-slate-200 px-8 py-4 flex justify-between items-center shadow-sm z-10">
            <div>
                <h2 id="current-step-title" class="text-lg font-bold text-slate-800">Step Title</h2>
                <p id="current-step-desc" class="text-sm text-slate-500">Description goes here</p>
            </div>
            <div class="flex gap-2">
                <button onclick="saveProject()" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-slate-600 bg-white border border-slate-300 rounded hover:bg-slate-50 transition">
                    <i data-lucide="save" class="w-4 h-4"></i> ä¿å­˜
                </button>
            </div>
        </header>

        <div id="editor-content" class="flex-1 overflow-y-auto p-8 pb-32">
            <!-- Dynamic Content Forms -->
        </div>

        <!-- Bottom Navigation for Wizard -->
        <div class="absolute bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-4 px-8 flex justify-between items-center z-20">
            <button onclick="prevStep()" id="btn-prev" class="px-4 py-2 text-slate-600 hover:text-indigo-600 transition flex items-center gap-2 disabled:opacity-50">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> å‰ã¸
            </button>
            <div class="flex gap-2">
                <span id="step-indicator" class="text-sm font-medium text-slate-500">1 / 6</span>
            </div>
            <button onclick="nextStep()" id="btn-next" class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition shadow flex items-center gap-2">
                æ¬¡ã¸ <i data-lucide="arrow-right" class="w-4 h-4"></i>
            </button>
        </div>
        
        <!-- AI Loading Overlay -->
        <div id="ai-loading-overlay" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center text-indigo-600">
            <div class="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
            <p id="loading-text" class="font-bold text-lg">AIãŒç”Ÿæˆä¸­...</p>
            <p class="text-sm text-slate-500">å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚ãã®ã¾ã¾ãŠå¾…ã¡ãã ã•ã„ã€‚</p>
        </div>
    </main>

    <!-- Right: Preview Panel -->
    <aside id="right-panel" class="w-[420px] bg-slate-100 border-l border-slate-200 flex flex-col items-center justify-center p-4 shadow-inner transition-all duration-300">
        <div class="mb-4 flex items-center gap-2 text-slate-500 text-sm font-medium">
            <i data-lucide="smartphone" class="w-4 h-4"></i> ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”»é¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        </div>
        
        <div class="phone-frame">
            <div class="phone-notch"></div>
            <!-- Simulation Container -->
            <div id="preview-screen" class="w-full h-full bg-slate-50 overflow-y-auto relative">
                <!-- Content injected via JS -->
            </div>
        </div>
        <p class="mt-4 text-xs text-slate-400 text-center px-8">
            ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã§ãƒãƒ£ãƒƒãƒˆã®ãƒ†ã‚¹ãƒˆé€ä¿¡ãŒå¯èƒ½ã§ã™ã€‚
        </p>
    </aside>

    <script>
        // --- DATA STRUCTURE & STATE ---
        
        const steps = [
            { id: 0, title: "åŸºæœ¬è¨­å®š", desc: "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åŸºæœ¬æƒ…å ±ã‚’å…¥åŠ›ã—ã¾ã™" },
            { id: 1, title: "åˆ°é”ç›®æ¨™", desc: "å­¦ç¿’è€…ã®Before/AfterçŠ¶æ…‹ã‚’å®šç¾©ã—ã¾ã™" },
            { id: 2, title: "ICEãƒ¢ãƒ‡ãƒ«è¨­è¨ˆ", desc: "Backward Designã¨è©³ç´°ãƒ«ãƒ¼ãƒ–ãƒªãƒƒã‚¯ã‚’è¨­å®šã—ã¾ã™" },
            { id: 3, title: "ã‚·ãƒŠãƒªã‚ªæ§‹ç¯‰", desc: "ã‚¹ãƒˆãƒ¼ãƒªãƒ¼æ¦‚è¦ã‹ã‚‰ã‚·ãƒ¼ãƒ³ã‚’è‡ªå‹•ç”Ÿæˆã€ã¾ãŸã¯æ‰‹å‹•ã§ç·¨é›†ã—ã¾ã™" },
            { id: 4, title: "å°å…¥ç‰©ã®åˆ¶ä½œ", desc: "é…å¸ƒç”¨ã®å°ç­’ã«å…¥ã‚Œã‚‹å­¦ç¿’ã‚¬ã‚¤ãƒ‰ã¨ã‚¹ãƒˆãƒ¼ãƒªãƒ¼å°å…¥ç´™ã‚’ä½œæˆã—ã¾ã™" },
            { id: 5, title: "ãƒ“ãƒ«ãƒ‰ãƒ»å‡ºåŠ›", desc: "ãƒ—ãƒ¬ã‚¤å¯èƒ½ãªHTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™" }
        ];

        let currentStep = 0;
        // Shared global api key storage for convenience within session
        let globalApiKey = "";

        // Default Data
        let projectData = {
            meta: { title: "ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°åŸºç¤ï¼šãƒšãƒ«ã‚½ãƒŠ", author: "EduDesigner" },
            goals: { before: "ã€Œãƒšãƒ«ã‚½ãƒŠã€ã¨ã„ã†è¨€è‘‰ã‚’æ›–æ˜§ã«ã—ã‹ç†è§£ã—ã¦ã„ãªã„", after: "ãƒšãƒ«ã‚½ãƒŠã‚’å®šç¾©ã—ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã®é•ã„ã‚’ç†è§£ã—ãŸä¸Šã§ã€æ´»ç”¨ã§ãã‚‹" },
            // Story Outline default is empty now, user can use template
            storyOutline: "",
            ice: {
                // Backward Design Concepts
                extensions: { q: "ç‹¬è‡ªã®ã‚«ãƒ•ã‚§ã‚’é–‹ããªã‚‰ã€ã©ã‚“ãªãƒšãƒ«ã‚½ãƒŠã‚’è¨­å®šã—ã€ã©ã‚“ãªã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã™ã‚‹ã‹ï¼Ÿ", goal: "å…·ä½“çš„ãªçŠ¶æ³ã§ãƒšãƒ«ã‚½ãƒŠã‚’ä½œæˆã—ã€æ–½ç­–ã‚’ææ¡ˆã§ãã‚‹" },
                connections: { q: "ã€Œã‚¿ãƒ¼ã‚²ãƒƒãƒˆã€ã¨ã€Œãƒšãƒ«ã‚½ãƒŠã€ã®é•ã„ã¯ä½•ã‹ï¼Ÿãªãœè©³ç´°ãªè¨­å®šãŒå¿…è¦ãªã®ã‹ï¼Ÿ", goal: "é–¢é€£æ¦‚å¿µã¨æ¯”è¼ƒã—ã€ãƒšãƒ«ã‚½ãƒŠã®å½¹å‰²ã‚’æ§‹é€ çš„ã«ç†è§£ã™ã‚‹" },
                ideas: { q: "ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã«ãŠã‘ã‚‹ã€Œãƒšãƒ«ã‚½ãƒŠã€ã¨ã¯ä½•ã‹ï¼Ÿ", goal: "ãƒšãƒ«ã‚½ãƒŠã®å®šç¾©ï¼ˆæ¶ç©ºã®å…¸å‹çš„ãªãƒ¦ãƒ¼ã‚¶ãƒ¼åƒï¼‰ã‚’èª¬æ˜ã§ãã‚‹" },
                // Detailed Rubric Matrix
                rubricMatrix: [
                    { 
                        category: "å®šç¾©ã¨ç†è§£", 
                        i_text: "ãƒšãƒ«ã‚½ãƒŠãŒã€Œæ¶ç©ºã®é¡§å®¢åƒã€ã§ã‚ã‚‹ã“ã¨ã‚’æ­£ç¢ºã«è¨˜è¿°ã§ãã¦ã„ã‚‹", i_score: 10,
                        c_text: "å˜ãªã‚‹ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå±æ€§ã¨ã®é•ã„ï¼ˆå¿ƒç†ã€è¡Œå‹•ãªã©ï¼‰ã‚’æ˜ç¢ºã«å¯¾æ¯”ã§ãã¦ã„ã‚‹", c_score: 10,
                        e_text: "ãªãœãƒšãƒ«ã‚½ãƒŠãŒå¿…è¦ãªã®ã‹ã€ãã®èƒŒæ™¯ã‚„åŠ¹æœã¾ã§è¸ã¿è¾¼ã‚“ã§å±•é–‹ã—ã¦ã„ã‚‹", e_score: 10
                    },
                    { 
                        category: "å¯¾è©±ã¨å¿œç”¨", 
                        i_text: "ç”Ÿå¾’ã®è³ªå•ã«å¯¾ã—ã¦ã€å°‚é–€ç”¨èªã‚’ä½¿ã‚ãšã«å™›ã¿ç •ã„ã¦ç­”ãˆã¦ã„ã‚‹", i_score: 10,
                        c_text: "ç”Ÿå¾’ã®èº«è¿‘ãªä¾‹ï¼ˆã‚«ãƒ•ã‚§ã‚„ã‚³ãƒ³ãƒ“ãƒ‹ãªã©ï¼‰ã«é–¢é€£ä»˜ã‘ã¦èª¬æ˜ã—ã¦ã„ã‚‹", c_score: 10,
                        e_text: "ç”Ÿå¾’è‡ªèº«ã«ãƒšãƒ«ã‚½ãƒŠã‚’è€ƒãˆã•ã›ã‚‹ã‚ˆã†ãªã€ç™ºå±•çš„ãªå•ã„ã‹ã‘ãŒã§ãã¦ã„ã‚‹", e_score: 10
                    }
                ]
            },
            // Onboarding Paper Materials
            onboarding: {
                paper1: {
                    title: "ã¾ãšåˆã‚ã«ã“ã®ç´™ã‚’èª­ã‚“ã§ãã ã•ã„",
                    contents: "ãƒ»å­¦ç¿’ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ï¼ˆæœ¬ç´™ï¼‰\nãƒ»ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆã‚¬ã‚¤ãƒ‰ï¼ˆQRã‚³ãƒ¼ãƒ‰ä»˜ãï¼‰\nãƒ»ãƒ¡ãƒ¢ç”¨ç´™",
                    howToPlay: "1. ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚¬ã‚¤ãƒ‰ï¼ˆã‚‚ã†1æšã®ç´™ï¼‰ã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ãƒãƒ›ã§èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚\n2. æ¶ç©ºã®ã‚¹ãƒãƒ›ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚æŒ‡ç¤ºã«å¾“ã£ã¦ã‚¢ãƒ—ãƒªã‚’æ“ä½œã—ã¦ãã ã•ã„ã€‚\n3. ã‚²ãƒ¼ãƒ å†…ã®æ™‚é–“ã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§é€²è¡Œã—ã¾ã™ã€‚é€šçŸ¥ãŒæ¥ãŸã‚‰å¿…ãšç¢ºèªã—ã¦ãã ã•ã„ã€‚\n4. é€”ä¸­ã§æ¤œç´¢ãªã©ã‚’è¡Œã„ãªãŒã‚‰ã€èª²é¡Œã«å–ã‚Šçµ„ã‚“ã§ãã ã•ã„ã€‚"
                },
                paper2: {
                    title: "ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼šæœªæ¥ã®è¬›å¸«ã¨ãªã‚Œ",
                    story: "ã‚ãªãŸã¯ã€Œæœªæ¥é€²å­¦å¡¾ã€ã®æ¡ç”¨è©¦é¨“ã‚’å—ã‘ã‚‹ã“ã¨ã«ãªã£ãŸå¡¾è¬›å¸«å€™è£œç”Ÿã§ã™ã€‚\nã“ã®å¡¾ã§ã¯ã€å˜ã«å‹‰å¼·ã‚’æ•™ãˆã‚‹ã ã‘ã§ãªãã€ç”Ÿå¾’ã®æ‚©ã¿ã‚„èˆˆå‘³ã«å¯„ã‚Šæ·»ã†ã€Œãƒšãƒ«ã‚½ãƒŠç†è§£ã€ã‚’æœ€é‡è¦è¦–ã—ã¦ã„ã¾ã™ã€‚\n\næ¡ç”¨è©¦é¨“ã®æœ€çµ‚èª²é¡Œã¯ã€ã‚ã‚‹ä¸€äººã®ç”Ÿå¾’ã¨ã®å¯¾è©±ã‚’é€šã˜ã¦ã€å½¼ã®å­¦ç¿’æ„æ¬²ã‚’å¼•ãå‡ºã™ã“ã¨ã€‚\nã‚ãªãŸã®æŒ‡å°åŠ›ãŒã€ä¸€äººã®å°‘å¹´ã®æœªæ¥ã‚’å¤‰ãˆã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚",
                    role: "æœªæ¥é€²å­¦å¡¾ã®ã‚¢ãƒ«ãƒã‚¤ãƒˆè¬›å¸«å€™è£œç”Ÿ",
                    action: "ãŠæ‰‹æŒã¡ã®ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§å³ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šã€\næœªæ¥é€²å­¦å¡¾ã®æ¡ç”¨ã‚µã‚¤ãƒˆã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦å¿œå‹Ÿæ‰‹ç¶šãã‚’è¡Œã£ã¦ãã ã•ã„ã€‚",
                    qrUrl: "https://example.com/game/start" // Default Placeholder
                }
            },
            nodes: [
                // ... (Same as previous nodes) ...
                 { id: "n1", type: "os_home", title: "ãƒ›ãƒ¼ãƒ ç”»é¢", content: "æ–°ã—ã„ãƒã‚¤ãƒˆã‚’æ¢ãã†ã€‚æ¤œç´¢ã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦ãã ã•ã„ã€‚", next: "n2", apps: ["search", "mail", "phone", "browser"] },
                { id: "n2", type: "search", title: "æ±‚äººæ¤œç´¢", query: "æœªæ¥é€²å­¦å¡¾ ãƒã‚¤ãƒˆ", hint: "ã€Œæœªæ¥é€²å­¦å¡¾ ãƒã‚¤ãƒˆã€ã§æ¤œç´¢ã—ã¦ã¿ã‚ˆã†", next: "n3" },
                { id: "n3", type: "web", title: "æ±‚äººã‚µã‚¤ãƒˆ", url: "recruit.mirai-juku.edu", html: "<div class='p-4 text-center'><h1 class='text-xl font-bold text-blue-600 mb-2'>æœªæ¥é€²å­¦å¡¾</h1><p class='text-sm mb-4'>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³è¬›å¸«å‹Ÿé›†ï¼<br>ã‚¹ã‚­ãƒæ™‚é–“ã§OKã€‚</p><button onclick='window.gameTrigger(\"n4\")' class='bg-orange-500 text-white px-6 py-2 rounded-full font-bold shadow hover:bg-orange-600'>å¿œå‹Ÿã™ã‚‹</button></div>", next: "n4" },
                { id: "n4", type: "form", title: "å¿œå‹Ÿãƒ•ã‚©ãƒ¼ãƒ ", fields: [{label: "æ°å", type: "text"}, {label: "å¿—æœ›å‹•æ©Ÿ", type: "textarea"}], submitText: "é€ä¿¡ã™ã‚‹", next: "n5" },
                { id: "n5", type: "delay", title: "å¾…æ©Ÿ(å¯©æŸ»ä¸­)", duration: 3000, next: "n6" }, 
                { id: "n6", type: "email", title: "æ¡ç”¨ãƒ¡ãƒ¼ãƒ«", sender: "hr@mirai-juku.edu", subject: "ã€æ¡ç”¨é€šçŸ¥ã€‘ä¸€æ¬¡å¯©æŸ»é€šé", body: "ã”å¿œå‹Ÿã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚\nä¸€æ¬¡å¯©æŸ»ã‚’é€šéã•ã‚Œã¾ã—ãŸã€‚\n\næœ€çµ‚ç¢ºèªã®ãŸã‚ã€ä»¥ä¸‹ã®ç•ªå·ã¸é›»è©±é€£çµ¡ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚", linkText: "å¡¾é•·ã«é›»è©±ã™ã‚‹", next: "n7" },
                { id: "n7", type: "phone", title: "é€šè©±: å¡¾é•·", caller: "æœªæ¥é€²å­¦å¡¾ å¡¾é•·", audio: "voice_dummy", duration: 6000, script: "é›»è©±ã‚ã‚ŠãŒã¨ã†ã€‚ã“ã®ç”Ÿå¾’ã®æ‹…å½“ã‚’ã—ã¦ã»ã—ã„ã€‚åŸºæœ¬ãƒãƒ£ãƒƒãƒˆã§ã®ãŠä»•äº‹ã ã‹ã‚‰ãŠé¡˜ã„ã­ï¼ãƒãƒ£ãƒƒãƒˆæ•™ãˆã¨ãã‹ã‚‰ã€ç”Ÿå¾’ã‹ã‚‰è³ªå•ãŒã‚ã£ãŸã‚‰é€ã£ã¦ã­ã€‚", next: "n8" },
                { id: "n8", type: "email", title: "æ¥­å‹™é€£çµ¡", sender: "manager@mirai-juku.edu", subject: "æ‹…å½“ç”Ÿå¾’ã«ã¤ã„ã¦", body: "æ‹…å½“ã—ã¦ã‚‚ã‚‰ã†ã€Œã‚±ãƒ³ã‚¿å›ã€ã®ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã§ã™ã€‚\nè³ªå•ãŒæ¥ã¦ã„ã‚‹ã‚ˆã†ãªã®ã§ã€å¯¾å¿œãŠé¡˜ã„ã—ã¾ã™ã€‚", linkText: "ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã¸ç§»å‹•", next: "n9" },
                { 
                    id: "n9", 
                    type: "chat", 
                    title: "æŒ‡å°ãƒãƒ£ãƒƒãƒˆ (ãƒšãƒ«ã‚½ãƒŠ)", 
                    partner: "ã‚±ãƒ³ã‚¿(ç”Ÿå¾’)", 
                    chatMode: "ai", 
                    modelName: "gemini-2.5-flash", // Updated Default
                    useIcePrompt: true, 
                    systemPrompt: "ã‚ãªãŸã¯å¥½å¥‡å¿ƒæ—ºç››ãªç”·å­é«˜æ ¡ç”Ÿã€Œã‚±ãƒ³ã‚¿ã€ã§ã™ã€‚ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã«å°‘ã—èˆˆå‘³ãŒã‚ã‚Šã¾ã™ã€‚\nå£èª¿ã¯ãƒ•ãƒ©ãƒ³ã‚¯ã§ã€ã€Œã€œã£ã™ã­ã€ã€Œãƒã‚¸ã§ï¼Ÿã€ãªã©ãŒå£ç™–ã§ã™ã€‚\n\nä»¥ä¸‹ã®é †åºã§å…ˆç”Ÿï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ã«è³ªå•ã—ã€ç†è§£ã‚’æ·±ã‚ã¦ãã ã•ã„ã€‚\n1. ã€å°å…¥ã€‘æ˜¨æ—¥å‹é”ã«ã€Œãƒšãƒ«ã‚½ãƒŠã€ã£ã¦ã™ã”ã„ã‚ˆãªã£ã¦è¨€ã‚ã‚ŒãŸã‘ã©ã€ã‚²ãƒ¼ãƒ ã®ã“ã¨ï¼Ÿãã‚Œã¨ã‚‚å¿ƒç†å­¦ï¼Ÿã¾ãšã¯ã€Œå®šç¾©ã€ã‚’èãã€‚\n2. ã€æ·±æ˜ã‚Šã€‘ã€Œã‚¿ãƒ¼ã‚²ãƒƒãƒˆã€ã¨ä½•ãŒé•ã†ã®ã‹ç–‘å•ã‚’æŒã¤ã€‚ã€Œ20ä»£ç”·æ€§ã€ã¨ã‹ã˜ã‚ƒãƒ€ãƒ¡ãªã®ï¼Ÿã¨èãã€‚\n3. ã€å¿œç”¨ã€‘ã‚‚ã—æ–‡åŒ–ç¥­ã§ã‚¿ãƒ”ã‚ªã‚«å±‹ã‚’ã‚„ã‚‹ãªã‚‰ã€ã©ã‚“ãªãƒšãƒ«ã‚½ãƒŠã«ã™ã‚Œã°ã„ã„ã‹ç›¸è«‡ã™ã‚‹ã€‚\n\nç´å¾—ã—ãŸã‚‰ã€Œãªã‚‹ã»ã©ï¼ã‚ã£ã¡ã‚ƒã‚ã‹ã£ãŸï¼ã€ã¨è¨€ã£ã¦ãã ã•ã„ã€‚",
                    apiKey: "",
                    exitCondition: "count",
                    exitValue: 5,
                    scoreThreshold: 40, 
                    passNext: "end_good", 
                    failNext: "end_bad",
                    initialImage: "https://placehold.co/600x400/e2e8f0/64748b?text=Note+Image", // Example initial image
                    messages: [{sender:"them", text:"å…ˆç”Ÿï¼æ˜¨æ—¥å‹é”ã«ã€Œã“ã‚Œã‹ã‚‰ã¯ãƒšãƒ«ã‚½ãƒŠãŒå¤§äº‹ã ã€ã£ã¦è¨€ã‚ã‚ŒãŸã‚“ã§ã™ã‘ã©ã€ãƒšãƒ«ã‚½ãƒŠã£ã¦ã‚ã®ã‚²ãƒ¼ãƒ ã®ã“ã¨ã£ã™ã‹ï¼Ÿãªã«ãã‚Œï¼Ÿ"}], 
                },
                { id: "end_good", type: "result", title: "Mission Complete", isGood: true, message: "ã‚±ãƒ³ã‚¿ã¯ãƒšãƒ«ã‚½ãƒŠã®é‡è¦æ€§ã‚’å®Œå…¨ã«ç†è§£ã—ã¾ã—ãŸï¼æ–‡åŒ–ç¥­ã‚‚æˆåŠŸã—ãã†ã§ã™ã€‚" },
                { id: "end_bad", type: "result", title: "Mission Failed", isGood: false, message: "ã‚±ãƒ³ã‚¿ã¯æ··ä¹±ã—ã¦ã„ã¾ã™ã€‚ã€Œã‚¿ãƒ¼ã‚²ãƒƒãƒˆã§è‰¯ããªã„ï¼Ÿã€ã¨è¨€ã„æ®‹ã—ã¦å»ã£ã¦ã„ãã¾ã—ãŸ..." }
            ]
        };

        // Reference Verbs for ICE
        const iceVerbs = {
            I: ["å®šç¾©ã¥ã‘ã‚‹", "è¨˜è¿°ã™ã‚‹", "èª¬æ˜ã™ã‚‹", "åˆ†é¡ã™ã‚‹", "æ¯”ã¹ã‚‹", "æ˜ã‚‰ã‹ã«ã™ã‚‹", "åˆ—æŒ™ã™ã‚‹", "ä½ç½®ã¥ã‘ã‚‹", "æ˜ç¢ºã«ç†è§£ã™ã‚‹"],
            C: ["å¿œç”¨ã™ã‚‹", "æ¯”è¼ƒã™ã‚‹", "å¯¾æ¯”ã™ã‚‹", "é¡åˆ¥ã™ã‚‹", "çµ„ç¹”åŒ–ã™ã‚‹", "åˆ†é¡ã™ã‚‹", "è­˜åˆ¥ã™ã‚‹", "è§£é‡ˆã™ã‚‹", "çµ±åˆã™ã‚‹", "ä¿®æ­£ã™ã‚‹", "è©•ä¾¡ã™ã‚‹", "è§£æ±ºã™ã‚‹"],
            E: ["è¨ˆç”»ã™ã‚‹", "å±•é–‹ã™ã‚‹", "è¨ºæ–­ã™ã‚‹", "è©•ä¾¡ã™ã‚‹", "æ—¢å­˜ã®è³‡æ–™ã«åŸºã¥ã„ã¦æ¨å®šã™ã‚‹", "å¯©ç†ã™ã‚‹", "äºˆæ¸¬ã™ã‚‹"]
        };

        // Current editing state
        let selectedNodeId = "n1";
        let previewChatHistory = [];
        let draggedItemIndex = null;

        // --- CORE UI FUNCTIONS ---

        function init() {
            renderNav();
            renderStep();
            lucide.createIcons();
        }

        function renderNav() {
            const nav = document.getElementById('step-nav');
            nav.innerHTML = steps.map((s, i) => `
                <button onclick="goToStep(${i})" class="w-full text-left px-6 py-3 text-sm font-medium transition flex items-center justify-between ${i === currentStep ? 'step-active' : 'text-slate-600 hover:bg-slate-50'}">
                    <span>${i}. ${s.title}</span>
                    ${i < currentStep ? '<i data-lucide="check-circle" class="w-3 h-3 text-green-500"></i>' : ''}
                </button>
            `).join('');
            
            document.getElementById('current-step-title').textContent = `Step ${currentStep}: ${steps[currentStep].title}`;
            document.getElementById('current-step-desc').textContent = steps[currentStep].desc;
            document.getElementById('step-indicator').textContent = `${currentStep + 1} / ${steps.length}`;
            
            document.getElementById('btn-prev').disabled = currentStep === 0;
            document.getElementById('btn-next').innerHTML = currentStep === 5 ? 
                'å®Œäº† <i data-lucide="check" class="w-4 h-4"></i>' : 
                'æ¬¡ã¸ <i data-lucide="arrow-right" class="w-4 h-4"></i>';

            lucide.createIcons();
        }

        function goToStep(index) {
            currentStep = index;
            renderNav();
            renderStep();
        }

        function nextStep() {
            if (currentStep < steps.length - 1) goToStep(currentStep + 1);
        }

        function prevStep() {
            if (currentStep > 0) goToStep(currentStep - 1);
        }

        function renderStep() {
            const container = document.getElementById('editor-content');
            const rightPanel = document.getElementById('right-panel');
            container.innerHTML = ''; 

            // Toggle Right Panel visibility for Paper Preview (Now Step 4)
            if(currentStep === 4) {
                 rightPanel.classList.add('hidden');
                 container.parentElement.classList.replace('flex-1', 'w-full');
            } else {
                 rightPanel.classList.remove('hidden');
                 container.parentElement.classList.replace('w-full', 'flex-1');
            }
            
            updatePreview(); // For phone preview

            switch(currentStep) {
                case 0: renderStep0(container); break;
                case 1: renderStep1(container); break;
                case 2: renderStep2(container); break;
                case 3: renderStep3(container); break; // Scenario Builder with AI
                case 4: renderPaperMaterials(container); break; // Paper Materials (Formerly Step 6)
                case 5: renderBuildScreen(container); break; // Build & Output (Formerly Step 7)
            }
        }

        // --- STEP RENDERERS ---

        function renderStep0(container) {
            container.innerHTML = `
                <div class="max-w-2xl bg-white p-6 rounded-lg shadow-sm">
                    <label class="block mb-4">
                        <span class="text-slate-700 font-semibold">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</span>
                        <input type="text" value="${projectData.meta.title}" oninput="projectData.meta.title = this.value" class="mt-1 block w-full border border-slate-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </label>
                    <label class="block mb-4">
                        <span class="text-slate-700 font-semibold">ä½œæˆè€…</span>
                        <input type="text" value="${projectData.meta.author}" oninput="projectData.meta.author = this.value" class="mt-1 block w-full border border-slate-300 rounded px-3 py-2">
                    </label>
                </div>
            `;
        }

        function renderStep1(container) {
            container.innerHTML = `
                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-red-400">
                        <h3 class="font-bold text-lg mb-2 text-red-600">Before (ç¾çŠ¶)</h3>
                        <textarea class="w-full h-32 border border-slate-200 rounded p-2" oninput="projectData.goals.before = this.value">${projectData.goals.before}</textarea>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-green-500">
                        <h3 class="font-bold text-lg mb-2 text-green-600">After (åˆ°é”ç›®æ¨™)</h3>
                        <textarea class="w-full h-32 border border-slate-200 rounded p-2" oninput="projectData.goals.after = this.value">${projectData.goals.after}</textarea>
                    </div>
                </div>
            `;
        }

        function renderStep2(container) {
            // Updated Step 2: AI Assistant + Backward Design + Detailed Matrix
            const concepts = [
                { key: 'extensions', label: 'E: Extensions (å¿œç”¨ãƒ»æ´»ç”¨)', color: 'purple', desc: 'æ–°ã—ãå¾—ãŸå­¦ã³ã‚’ã€ä»–ã®æ–‡è„ˆã‚„å°†æ¥ã«ã©ã†æ´»ã‹ã™ã‹ï¼Ÿ' },
                { key: 'connections', label: 'C: Connections (é–¢é€£ãƒ»ã¤ãªãŒã‚Š)', color: 'blue', desc: 'ã™ã§ã«çŸ¥ã£ã¦ã„ã‚‹ã“ã¨ã¨ã€æ–°ã—ã„çŸ¥è­˜ã‚’ã©ã†é–¢é€£ä»˜ã‘ã‚‹ã‹ï¼Ÿ' },
                { key: 'ideas', label: 'I: Ideas (åŸºç¤ãƒ»çŸ¥è­˜)', color: 'orange', desc: 'æœ€ä½é™è¦šãˆã‚‹ã¹ãç”¨èªã‚„äº‹å®Ÿã¯ä½•ã‹ï¼Ÿ' }
            ];

            const renderMatrixRows = () => {
                return projectData.ice.rubricMatrix.map((row, idx) => `
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition">
                        <td class="p-3 align-top w-32">
                            <input type="text" class="w-full text-sm font-bold border-none bg-transparent focus:ring-0" value="${row.category}" placeholder="è©•ä¾¡é …ç›®" onchange="updateMatrix(${idx}, 'category', this.value)">
                            <button onclick="removeMatrixRow(${idx})" class="text-xs text-red-400 hover:text-red-600 mt-2 block"><i data-lucide="trash-2" class="w-3 h-3 inline"></i> å‰Šé™¤</button>
                        </td>
                        <td class="p-3 align-top bg-orange-50/30">
                            <textarea class="w-full text-xs border border-slate-200 rounded p-1 h-20 bg-white" onchange="updateMatrix(${idx}, 'i_text', this.value)">${row.i_text}</textarea>
                            <div class="flex items-center gap-1 mt-1 justify-end">
                                <span class="text-[10px] text-slate-400">é…ç‚¹</span>
                                <input type="number" class="w-12 text-xs border rounded p-1 text-right" value="${row.i_score}" onchange="updateMatrix(${idx}, 'i_score', this.value)">
                            </div>
                        </td>
                        <td class="p-3 align-top bg-blue-50/30">
                            <textarea class="w-full text-xs border border-slate-200 rounded p-1 h-20 bg-white" onchange="updateMatrix(${idx}, 'c_text', this.value)">${row.c_text}</textarea>
                            <div class="flex items-center gap-1 mt-1 justify-end">
                                <span class="text-[10px] text-slate-400">é…ç‚¹</span>
                                <input type="number" class="w-12 text-xs border rounded p-1 text-right" value="${row.c_score}" onchange="updateMatrix(${idx}, 'c_score', this.value)">
                            </div>
                        </td>
                        <td class="p-3 align-top bg-purple-50/30">
                            <textarea class="w-full text-xs border border-slate-200 rounded p-1 h-20 bg-white" onchange="updateMatrix(${idx}, 'e_text', this.value)">${row.e_text}</textarea>
                            <div class="flex items-center gap-1 mt-1 justify-end">
                                <span class="text-[10px] text-slate-400">é…ç‚¹</span>
                                <input type="number" class="w-12 text-xs border rounded p-1 text-right" value="${row.e_score}" onchange="updateMatrix(${idx}, 'e_score', this.value)">
                            </div>
                        </td>
                    </tr>
                `).join('');
            };

            container.innerHTML = `
                <div class="space-y-8 pb-10">
                    <!-- AI Assistant Section -->
                    <section class="bg-gradient-to-r from-indigo-50 to-blue-50 p-4 rounded-lg border border-indigo-100">
                        <h3 class="font-bold text-lg text-indigo-800 mb-2 flex items-center gap-2">
                            <i data-lucide="bot" class="text-indigo-600"></i> ğŸ”° åˆå¿ƒè€…å‘ã‘: AIè‡ªå‹•è¨­è¨ˆã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
                        </h3>
                        <p class="text-xs text-slate-600 mb-3">æ•™è‚²å·¥å­¦ã®çŸ¥è­˜ãŒãªãã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™ã€‚æ•™ãˆãŸã„ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›ã™ã‚Œã°ã€AIãŒICEãƒ¢ãƒ‡ãƒ«ã¨ãƒ«ãƒ¼ãƒ–ãƒªãƒƒã‚¯ã‚’è‡ªå‹•ä½œæˆã—ã¾ã™ã€‚</p>
                        <div class="flex gap-2 items-start">
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-slate-500 mb-1">å­¦ç¿’ãƒ†ãƒ¼ãƒ</label>
                                <input type="text" id="ai-ice-topic" class="w-full border rounded px-3 py-2 text-sm" placeholder="ä¾‹ï¼šå°å­¦æ ¡ã®äº¤é€šå®‰å…¨ã€æ–°äººç ”ä¿®ã®ååˆºäº¤æ›ã€æˆ¦å›½æ™‚ä»£ã®åˆæˆ¦">
                            </div>
                            <div class="w-48">
                                <label class="block text-xs font-bold text-slate-500 mb-1">API Key</label>
                                <input type="password" id="ai-ice-key" class="w-full border rounded px-3 py-2 text-sm" placeholder="Gemini API Key">
                            </div>
                        </div>
                        <button onclick="generateIceWithAI()" class="mt-3 bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold shadow hover:bg-indigo-700 flex items-center gap-2 transition">
                            <i data-lucide="sparkles" class="w-4 h-4"></i> AIã§è¨­è¨ˆæ¡ˆã‚’ä½œæˆãƒ»åæ˜ 
                        </button>
                    </section>

                    <section>
                        <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="compass" class="text-indigo-600"></i> 1. Backward Design (æ¦‚å¿µè¨­è¨ˆ)
                        </h3>
                        <div class="grid grid-cols-3 gap-4">
                            ${concepts.map(s => `
                                <div class="bg-white p-4 rounded-lg shadow-sm border-t-4 border-${s.color}-500">
                                    <h4 class="font-bold text-${s.color}-600 mb-1 text-sm">${s.label}</h4>
                                    <p class="text-[10px] text-slate-400 mb-3 h-8">${s.desc}</p>
                                    <label class="block text-xs font-bold text-slate-600 mb-1">æœ¬è³ªçš„ãªå•ã„</label>
                                    <textarea class="w-full border rounded px-2 py-1 text-xs h-16 mb-2" oninput="projectData.ice['${s.key}'].q = this.value">${projectData.ice[s.key].q}</textarea>
                                    <label class="block text-xs font-bold text-slate-600 mb-1">å…¨ä½“ç›®æ¨™</label>
                                    <input type="text" class="w-full border rounded px-2 py-1 text-xs" value="${projectData.ice[s.key].goal || ''}" oninput="projectData.ice['${s.key}'].goal = this.value">
                                </div>
                            `).join('')}
                        </div>
                    </section>
                    <section>
                        <div class="flex justify-between items-end mb-4">
                            <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                                <i data-lucide="table" class="text-indigo-600"></i> 2. ICEãƒ«ãƒ¼ãƒ–ãƒªãƒƒã‚¯ (è©•ä¾¡è¡¨)
                            </h3>
                            <button onclick="addMatrixRow()" class="text-xs bg-indigo-600 text-white px-3 py-1.5 rounded hover:bg-indigo-700 flex items-center gap-1">
                                <i data-lucide="plus"></i> é …ç›®è¿½åŠ 
                            </button>
                        </div>
                        <div class="bg-white rounded-lg shadow overflow-hidden border border-slate-200">
                            <table class="w-full">
                                <thead class="bg-slate-50 text-xs text-slate-500 uppercase font-bold border-b border-slate-200">
                                    <tr>
                                        <th class="p-3 text-left w-32">è©•ä¾¡é …ç›®</th>
                                        <th class="p-3 text-left text-orange-600 w-1/4">I: åŸºç¤ãƒ»çŸ¥è­˜</th>
                                        <th class="p-3 text-left text-blue-600 w-1/4">C: é–¢é€£ãƒ»ã¤ãªãŒã‚Š</th>
                                        <th class="p-3 text-left text-purple-600 w-1/4">E: å¿œç”¨ãƒ»æ´»ç”¨</th>
                                    </tr>
                                </thead>
                                <tbody id="rubric-table-body">
                                    ${renderMatrixRows()}
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>
            `;
            
            // Restore API Key if available in global var
            if(globalApiKey) {
                const keyInput = document.getElementById('ai-ice-key');
                if(keyInput) keyInput.value = globalApiKey;
            }

            lucide.createIcons();
        }

        // --- AI ICE GENERATION ---
        async function generateIceWithAI() {
            const topic = document.getElementById('ai-ice-topic').value;
            const apiKey = document.getElementById('ai-ice-key').value;

            if (!topic || !apiKey) {
                alert("å­¦ç¿’ãƒ†ãƒ¼ãƒã¨APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }
            
            // Save API Key temporarily
            globalApiKey = apiKey;

            const overlay = document.getElementById('ai-loading-overlay');
            document.getElementById('loading-text').textContent = "æ•™è‚²å·¥å­¦AIãŒè¨­è¨ˆä¸­...";
            overlay.classList.remove('hidden');

            const prompt = `
                ã‚ãªãŸã¯æ•™è‚²å·¥å­¦ã®å°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®ã€Œå­¦ç¿’ãƒ†ãƒ¼ãƒã€ã«åŸºã¥ã„ã¦ã€ICEãƒ¢ãƒ‡ãƒ«ï¼ˆIdeas, Connections, Extensionsï¼‰ã‚’ç”¨ã„ãŸå­¦ç¿’è¨­è¨ˆã¨è©•ä¾¡ãƒ«ãƒ¼ãƒ–ãƒªãƒƒã‚¯ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
                
                å­¦ç¿’ãƒ†ãƒ¼ãƒ: ${topic}

                ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•ã¯å«ã‚ãªã„ã§ãã ã•ã„ï¼‰ã€‚
                {
                    "ice": {
                        "ideas": { "q": "Iãƒ¬ãƒ™ãƒ«(åŸºç¤çŸ¥è­˜)ã®æœ¬è³ªçš„ãªå•ã„", "goal": "Iãƒ¬ãƒ™ãƒ«ã®å­¦ç¿’ç›®æ¨™" },
                        "connections": { "q": "Cãƒ¬ãƒ™ãƒ«(é–¢é€£ä»˜ã‘)ã®æœ¬è³ªçš„ãªå•ã„", "goal": "Cãƒ¬ãƒ™ãƒ«ã®å­¦ç¿’ç›®æ¨™" },
                        "extensions": { "q": "Eãƒ¬ãƒ™ãƒ«(å¿œç”¨ãƒ»æ´»ç”¨)ã®æœ¬è³ªçš„ãªå•ã„", "goal": "Eãƒ¬ãƒ™ãƒ«ã®å­¦ç¿’ç›®æ¨™" },
                        "rubricMatrix": [
                            {
                                "category": "è©•ä¾¡é …ç›®1 (ä¾‹: ç†è§£åº¦)",
                                "i_text": "Iãƒ¬ãƒ™ãƒ«ã®è©•ä¾¡åŸºæº–", "i_score": 10,
                                "c_text": "Cãƒ¬ãƒ™ãƒ«ã®è©•ä¾¡åŸºæº–", "c_score": 10,
                                "e_text": "Eãƒ¬ãƒ™ãƒ«ã®è©•ä¾¡åŸºæº–", "e_score": 10
                            },
                            {
                                "category": "è©•ä¾¡é …ç›®2 (ä¾‹: æ€è€ƒåŠ›)",
                                "i_text": "...", "i_score": 10,
                                "c_text": "...", "c_score": 10,
                                "e_text": "...", "e_score": 10
                            }
                        ]
                    }
                }
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ role: "user", parts: [{ text: prompt }] }]
                    })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                const jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const result = JSON.parse(jsonStr);

                // Update Data
                if(result.ice) {
                    projectData.ice = result.ice;
                    renderStep(); // Re-render to show new data
                    alert("è¨­è¨ˆãŒå®Œäº†ã—ã¾ã—ãŸï¼å†…å®¹ã‚’ç¢ºèªãƒ»èª¿æ•´ã—ã¦ãã ã•ã„ã€‚");
                } else {
                    throw new Error("Invalid format received");
                }

            } catch (e) {
                alert("ç”Ÿæˆã‚¨ãƒ©ãƒ¼: " + e.message);
            } finally {
                overlay.classList.add('hidden');
            }
        }


        function addMatrixRow() {
            projectData.ice.rubricMatrix.push({ category: "æ–°è¦é …ç›®", i_text: "", i_score: 0, c_text: "", c_score: 0, e_text: "", e_score: 0 });
            renderStep();
        }

        function removeMatrixRow(idx) {
            if(confirm("ã“ã®è¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                projectData.ice.rubricMatrix.splice(idx, 1);
                renderStep();
            }
        }

        function updateMatrix(idx, key, val) {
            projectData.ice.rubricMatrix[idx][key] = val;
        }

        // --- STEP 3: Scenario Builder with AI ---
        function renderStep3(container) {
            const nodeTypes = {
                'os_home': 'Home Screen', 'search': 'Search App', 'web': 'Web Browser', 
                'form': 'Form App', 'phone': 'Phone Call', 'email': 'Email', 
                'video': 'Video Call', 'chat': 'Chat App', 'delay': 'Time Delay', 'result': 'End Screen'
            };
            const selectedNode = projectData.nodes.find(n => n.id === selectedNodeId) || projectData.nodes[0];

            // Auto-fill API key if present
            const apiKeyVal = globalApiKey || "";

            container.innerHTML = `
                <div class="flex flex-col h-full gap-4">
                    <!-- Story Design Panel -->
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <i data-lucide="book-open" class="text-indigo-600"></i>
                                <h3 class="font-bold text-indigo-900">ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è¨­è¨ˆ (ãƒ—ãƒ­ãƒƒãƒˆ)</h3>
                            </div>
                            <button onclick="applyStoryTemplate()" class="text-xs bg-white text-indigo-600 border border-indigo-200 px-3 py-1.5 rounded hover:bg-indigo-50 flex items-center gap-1 transition">
                                <i data-lucide="file-text" class="w-3 h-3"></i> å‚è€ƒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æŒ¿å…¥
                            </button>
                        </div>
                        
                        <textarea id="story-outline-area" class="w-full text-sm border border-indigo-200 rounded p-3 h-32 focus:ring-2 focus:ring-indigo-500 focus:border-transparent mb-3" placeholder="ã“ã“ã«ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã®ã‚ã‚‰ã™ã˜ã‚’è‡ªç”±ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚&#10;ä¾‹: ä¸»äººå…¬ãŒ...ã—ã¦ã€...ã¨ã„ã†çµæœ«ã«ãªã‚‹ã€‚" oninput="projectData.storyOutline = this.value">${projectData.storyOutline || ''}</textarea>
                        
                        <div class="flex items-center gap-2 pt-2 border-t border-indigo-100">
                            <div class="flex-1 text-xs text-indigo-800 font-bold flex items-center gap-2">
                                <i data-lucide="sparkles" class="w-4 h-4"></i> AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆæ©Ÿèƒ½
                            </div>
                             <input type="text" id="gen-model-name" class="w-32 border rounded px-3 py-1.5 text-xs" placeholder="Model Name" value="gemini-2.5-flash">
                            <input type="password" id="gen-api-key" class="w-48 border rounded px-3 py-1.5 text-xs" placeholder="Gemini API Key (å¿…é ˆ)" value="${apiKeyVal}" onchange="globalApiKey = this.value">
                            <button onclick="generateScenarioWithAI()" class="bg-indigo-600 text-white px-4 py-1.5 rounded hover:bg-indigo-700 text-xs font-bold shadow flex items-center gap-2 transition transform hover:scale-105">
                                <i data-lucide="wand-2" class="w-3 h-3"></i> ã“ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‹ã‚‰ã‚·ãƒ¼ãƒ³ã‚’è‡ªå‹•ç”Ÿæˆ
                            </button>
                        </div>
                    </div>

                    <!-- Main Editor Layout -->
                    <div class="flex flex-1 gap-6 min-h-0">
                        <!-- Node List -->
                        <div class="w-1/3 bg-white rounded-lg shadow-sm border border-slate-200 flex flex-col">
                            <div class="p-3 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-lg">
                                <span class="font-bold text-sm">ã‚·ãƒ¼ãƒ³ä¸€è¦§</span>
                                <button onclick="addNode()" class="text-xs bg-indigo-600 text-white px-2 py-1 rounded hover:bg-indigo-700">+ è¿½åŠ </button>
                            </div>
                            <div class="flex-1 overflow-y-auto p-2 space-y-2">
                                ${projectData.nodes.map((n, index) => `
                                    <div 
                                        draggable="true" 
                                        ondragstart="onDragStart(event, ${index})" 
                                        ondragover="onDragOver(event)" 
                                        ondragleave="onDragLeave(event)"
                                        ondrop="onDrop(event, ${index})"
                                        ondragend="onDragEnd(event)"
                                        class="flex gap-1 items-stretch draggable-item"
                                    >
                                        <div class="flex flex-col justify-center gap-1 pr-1 cursor-move text-slate-300 hover:text-indigo-500">
                                             <i data-lucide="grip-vertical" class="w-4 h-4"></i>
                                        </div>
                                        <div class="flex flex-col justify-center gap-1 pr-1">
                                            <button onclick="moveNode(${index}, -1)" class="text-slate-400 hover:text-indigo-600 p-0.5 rounded ${index === 0 ? 'opacity-20 cursor-default' : ''}" ${index === 0 ? 'disabled' : ''}><i data-lucide="chevron-up" class="w-3 h-3"></i></button>
                                            <button onclick="moveNode(${index}, 1)" class="text-slate-400 hover:text-indigo-600 p-0.5 rounded ${index === projectData.nodes.length - 1 ? 'opacity-20 cursor-default' : ''}" ${index === projectData.nodes.length - 1 ? 'disabled' : ''}><i data-lucide="chevron-down" class="w-3 h-3"></i></button>
                                        </div>
                                        <div onclick="selectNode('${n.id}')" class="flex-1 p-3 rounded cursor-pointer border ${selectedNodeId === n.id ? 'bg-indigo-50 border-indigo-500' : 'bg-white border-slate-200 hover:bg-slate-50'}">
                                            <div class="flex items-center justify-between mb-1">
                                                <span class="font-bold text-xs text-slate-500">${n.id}</span>
                                                <span class="text-[10px] bg-slate-200 px-1.5 py-0.5 rounded text-slate-600">${nodeTypes[n.type]}</span>
                                            </div>
                                            <div class="text-sm font-medium truncate">${n.title}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Node Editor -->
                        <div class="flex-1 bg-white rounded-lg shadow-sm border border-slate-200 p-6 overflow-y-auto">
                            <div class="flex justify-between mb-6">
                                <h3 class="font-bold text-lg">ã‚·ãƒ¼ãƒ³ç·¨é›†: ${selectedNode.id}</h3>
                                <button onclick="deleteNode('${selectedNode.id}')" class="text-red-500 hover:text-red-700 text-sm flex items-center gap-1"><i data-lucide="trash-2" class="w-3 h-3"></i> å‰Šé™¤</button>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-600">ID</label>
                                        <input type="text" disabled value="${selectedNode.id}" class="w-full bg-slate-100 border rounded px-3 py-2 text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-600">ã‚¿ã‚¤ãƒ—</label>
                                        <select onchange="updateNodeType('${selectedNode.id}', this.value)" class="w-full border rounded px-3 py-2 text-sm">
                                            ${Object.entries(nodeTypes).map(([k, v]) => `<option value="${k}" ${selectedNode.type === k ? 'selected' : ''}>${v}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-slate-600">ã‚¿ã‚¤ãƒˆãƒ« (ç®¡ç†ç”¨)</label>
                                    <input type="text" value="${selectedNode.title}" oninput="updateNodeField('${selectedNode.id}', 'title', this.value)" class="w-full border rounded px-3 py-2 text-sm">
                                </div>

                                <!-- Dynamic Fields based on Type -->
                                ${renderNodeSpecificFields(selectedNode)}

                                <div class="pt-4 border-t border-slate-100">
                                    <div class="flex items-center justify-between mb-1">
                                        <label class="block text-xs font-bold text-slate-600">æ¬¡ã®ã‚·ãƒ¼ãƒ³è¨­å®š</label>
                                    </div>
                                    
                                    ${selectedNode.type === 'chat' && selectedNode.chatMode === 'ai' ? `
                                        <div class="bg-indigo-50 p-3 rounded space-y-2">
                                            <div class="text-xs font-bold text-indigo-700 mb-1 flex items-center gap-1"><i data-lucide="git-branch" class="w-3 h-3"></i> ã‚¹ã‚³ã‚¢åˆ†å²è¨­å®š</div>
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs">åˆæ ¼ç‚¹:</span>
                                                <input type="number" value="${selectedNode.scoreThreshold || 60}" oninput="updateNodeField('${selectedNode.id}', 'scoreThreshold', this.value)" class="w-16 border rounded px-2 py-1 text-xs">
                                                <span class="text-xs">ç‚¹ä»¥ä¸Š</span>
                                            </div>
                                            <div class="grid grid-cols-2 gap-2">
                                                <div>
                                                    <span class="text-xs text-green-600 block">åˆæ ¼æ™‚ (Success)</span>
                                                    <input type="text" value="${selectedNode.passNext || ''}" oninput="updateNodeField('${selectedNode.id}', 'passNext', this.value)" class="w-full border border-green-200 rounded px-2 py-1 text-xs" placeholder="Node ID">
                                                </div>
                                                <div>
                                                    <span class="text-xs text-red-600 block">ä¸åˆæ ¼æ™‚ (Fail)</span>
                                                    <input type="text" value="${selectedNode.failNext || ''}" oninput="updateNodeField('${selectedNode.id}', 'failNext', this.value)" class="w-full border border-red-200 rounded px-2 py-1 text-xs" placeholder="Node ID">
                                                </div>
                                            </div>
                                        </div>
                                    ` : `
                                        <input type="text" value="${selectedNode.next || ''}" oninput="updateNodeField('${selectedNode.id}', 'next', this.value)" class="w-full border rounded px-3 py-2 text-sm bg-slate-50" placeholder="é·ç§»å…ˆã®Node IDã‚’å…¥åŠ›">
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }
        
        // --- Story Template Helper ---
        function applyStoryTemplate() {
            const templateText = "ã“ã‚Œã¯ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå¡¾ã®ã‚¢ãƒ«ãƒã‚¤ãƒˆã«å¿œå‹Ÿã—ã€3ç§’å¾Œã«æ¡ç”¨ã®ãƒ¡ãƒ¼ãƒ«ãŒå±Šãã€ãã®ãƒ¡ãƒ¼ãƒ«ã«å¡¾é•·ã«é€£çµ¡ã‚’ã™ã‚‹æ—¨ãŒæ›¸ã„ã¦ã‚ã£ã¦ã€é›»è©±ã‚’ã™ã‚‹ã¨ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ã«ãªã‚ŠãŸã„ç”Ÿå¾’ã‚’ä»»ã•ã‚ŒãŸã„ã¨ä¸€æ–¹çš„ã«è©±ã•ã‚Œã‚‹ã€‚ãã®å¾Œã€ãƒ¡ãƒ¼ãƒ«ãŒå±Šãã€ãã®ç”Ÿå¾’ã¨ã®ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã¸ã¨æ¡ˆå†…ã•ã‚Œã‚‹ã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ç”Ÿå¾’ã¨ã®ãƒãƒ£ãƒƒãƒˆã‚’é€šã—ã¦ç”Ÿå¾’ã®å¤¢ã‚’å¿œæ´ã™ã‚‹ã€‚ã‚‚ã—ç”Ÿå¾’ã®å¤¢ã‚’å¶ãˆã‚‰ã‚ŒãŸã‚‰ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ã€‚ç”Ÿå¾’ã«ç´å¾—ã•ã‚Œãšå¤¢ã‚’å¶ãˆã‚‰ã‚Œãªã‹ã£ãŸã‚‰ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã€‚å­¦é•·ã‹ã‚‰ãŠå±ã‚Šã®é›»è©±ãŒãã‚‹ã€‚";
            
            const textarea = document.getElementById('story-outline-area');
            if(textarea) {
                textarea.value = templateText;
                projectData.storyOutline = templateText;
                // Flash effect
                textarea.classList.add('bg-indigo-100');
                setTimeout(() => textarea.classList.remove('bg-indigo-100'), 300);
            }
        }

        // AI SCENARIO GENERATOR
        async function generateScenarioWithAI() {
            const apiKey = document.getElementById('gen-api-key').value;
            const modelName = document.getElementById('gen-model-name').value || 'gemini-2.5-flash';
            if(!apiKey) {
                alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }
            
            // Save key
            globalApiKey = apiKey;
            
            const overlay = document.getElementById('ai-loading-overlay');
            document.getElementById('loading-text').textContent = "AIãŒã‚·ãƒŠãƒªã‚ªã‚’ç”Ÿæˆä¸­...";
            overlay.classList.remove('hidden');
            
            const prompt = `
                ã‚ãªãŸã¯æ•™è‚²ã‚²ãƒ¼ãƒ ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®æƒ…å ±ã«åŸºã¥ã„ã¦ã€ARGï¼ˆä»£æ›¿ç¾å®Ÿã‚²ãƒ¼ãƒ ï¼‰ã®ã‚·ãƒŠãƒªã‚ªãƒãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‚’JSONå½¢å¼ã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

                [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±]
                ã‚¿ã‚¤ãƒˆãƒ«: ${projectData.meta.title}
                å­¦ç¿’ç›®æ¨™: ${projectData.goals.after}
                ã‚¹ãƒˆãƒ¼ãƒªãƒ¼æ¦‚è¦: ${projectData.storyOutline}
                
                [ICEãƒ¢ãƒ‡ãƒ«(å­¦ç¿’åˆ°é”ç›®æ¨™)]
                I(åŸºç¤): ${projectData.ice.ideas.q}
                C(é–¢é€£): ${projectData.ice.connections.q}
                E(å¿œç”¨): ${projectData.ice.extensions.q}
                
                [è¦ä»¶]
                1. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã‚¹ãƒãƒ›ç”»é¢ä¸Šã®ã‚¢ãƒ—ãƒª(æ¤œç´¢, Web, é›»è©±, ãƒ¡ãƒ¼ãƒ«, ãƒãƒ£ãƒƒãƒˆ)ã‚’æ“ä½œã—ã¦é€²ã‚€å½¢å¼ã§ã™ã€‚
                2. ãƒãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ã¯ä»¥ä¸‹ã‹ã‚‰é©åˆ‡ãªã‚‚ã®ã‚’é¸ã‚“ã§ãã ã•ã„:
                   - 'os_home': ãƒ›ãƒ¼ãƒ ç”»é¢ (å¿…é ˆ: æœ€åˆã¯ã“ã‚Œ)
                   - 'search': æ¤œç´¢ã‚¢ãƒ—ãƒª (queryã§æ­£è§£ãƒ¯ãƒ¼ãƒ‰ã‚’æŒ‡å®š)
                   - 'web': Webã‚µã‚¤ãƒˆè¡¨ç¤º
                   - 'form': å¿œå‹Ÿãƒ•ã‚©ãƒ¼ãƒ ãªã©
                   - 'phone': æ¶ç©ºã®ç€ä¿¡
                   - 'email': ãƒ¡ãƒ¼ãƒ«ã®å—ä¿¡
                   - 'chat': ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¢ãƒ—ãƒª
                   - 'delay': å¾…æ©Ÿæ™‚é–“æ¼”å‡º
                   - 'result': ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚° (Good/Bad)
                3. ãƒãƒ£ãƒƒãƒˆãƒãƒ¼ãƒ‰('chat')ã§ã¯ã€ç”Ÿå¾’å½¹ãŒICEãƒ¢ãƒ‡ãƒ«ã«åŸºã¥ã„ãŸè³ªå•ã‚’ã™ã‚‹ã‚ˆã†ã« 'systemPrompt' ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
                4. æœ€åˆã®ãƒãƒ¼ãƒ‰IDã¯å¿…ãš 'n1' ã¨ã—ã€é·ç§»å…ˆ('next')ã§ãƒãƒ¼ãƒ‰ã‚’ç¹‹ã’ã¦ãã ã•ã„ã€‚
                5. å‡ºåŠ›ã¯ç´”ç²‹ãªJSONé…åˆ—ã®ã¿ã«ã—ã¦ãã ã•ã„ï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•ãªã—ï¼‰ã€‚
                
                [å‡ºåŠ›JSONæ§‹é€ ã®ä¾‹]
                [
                  { "id": "n1", "type": "os_home", "title": "ãƒ›ãƒ¼ãƒ ", "content": "...", "next": "n2", "apps": ["search", "mail", "phone", "browser"] },
                  { "id": "n2", "type": "search", "title": "æ¤œç´¢", "query": "...", "hint": "...", "next": "n3" },
                  ...
                  { "id": "end_good", "type": "result", "title": "Good End", "isGood": true, "message": "..." }
                ]
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ role: "user", parts: [{ text: prompt }] }]
                    })
                });
                
                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                const jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const newNodes = JSON.parse(jsonStr);
                
                // Validate basic structure
                if(Array.isArray(newNodes) && newNodes.length > 0) {
                    projectData.nodes = newNodes;
                    selectedNodeId = newNodes[0].id;
                    renderStep(); // Refresh
                    alert("ã‚·ãƒŠãƒªã‚ªã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼");
                } else {
                    throw new Error("Invalid JSON format");
                }
                
            } catch(e) {
                alert("ç”Ÿæˆã‚¨ãƒ©ãƒ¼: " + e.message);
            } finally {
                overlay.classList.add('hidden');
            }
        }

        // ... (Rest of the helper functions and renderers remain same) ...
        
        function handleImageUpload(event, nodeId) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                updateNodeField(nodeId, 'initialImage', e.target.result);
            };
            reader.readAsDataURL(file);
        }

        function renderNodeSpecificFields(node) {
            let html = '';
            const mkInput = (lbl, key, val, type='text', placeholder='') => `
                <div class="mb-2">
                    <label class="block text-xs font-bold text-slate-600 mb-1">${lbl}</label>
                    <input type="${type}" value="${val || ''}" placeholder="${placeholder}" oninput="updateNodeField('${node.id}', '${key}', this.value)" class="w-full border rounded px-3 py-2 text-sm">
                </div>`;
            
            const mkTextarea = (lbl, key, val) => `
                <div class="mb-2">
                    <label class="block text-xs font-bold text-slate-600 mb-1">${lbl}</label>
                    <textarea oninput="updateNodeField('${node.id}', '${key}', this.value)" class="w-full border rounded px-3 py-2 text-sm h-24">${val || ''}</textarea>
                </div>`;

            if (node.type === 'search') {
                html += mkInput('æ­£è§£æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰', 'query', node.query);
                html += mkInput('ãƒ’ãƒ³ãƒˆæ–‡', 'hint', node.hint);
            } else if (node.type === 'web') {
                html += mkInput('URLãƒãƒ¼è¡¨ç¤º', 'url', node.url);
                html += mkTextarea('ãƒšãƒ¼ã‚¸å†…HTML (Tailwindå¯)', 'html', node.html);
            } else if (node.type === 'form') {
                html += `<div class="p-2 bg-yellow-50 text-xs text-yellow-800 rounded mb-2">ãƒ•ã‚©ãƒ¼ãƒ é …ç›®ã¯å›ºå®šãƒ—ãƒªã‚»ãƒƒãƒˆ(æ°åãƒ»å¿—æœ›å‹•æ©Ÿ)ã§ã™ï¼ˆãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ä»•æ§˜ï¼‰</div>`;
                html += mkInput('é€ä¿¡ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ', 'submitText', node.submitText);
            } else if (node.type === 'phone') {
                html += mkInput('ç™ºä¿¡è€…å', 'caller', node.caller);
                html += mkInput('é€šè©±æ™‚é–“(ms)', 'duration', node.duration, 'number');
                html += mkTextarea('é€šè©±å†…å®¹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ(ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨)', 'script', node.script);
            } else if (node.type === 'email') {
                html += mkInput('å·®å‡ºäºº', 'sender', node.sender);
                html += mkInput('ä»¶å', 'subject', node.subject);
                html += mkTextarea('æœ¬æ–‡', 'body', node.body);
                html += mkInput('ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³å', 'linkText', node.linkText);
            } else if (node.type === 'delay') {
                html += mkInput('å¾…æ©Ÿæ™‚é–“(ms)', 'duration', node.duration, 'number');
            } else if (node.type === 'chat') {
                html += mkInput('ãƒãƒ£ãƒƒãƒˆç›¸æ‰‹ã®åå‰', 'partner', node.partner);
                html += mkInput('åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸', 'initialMsg', node.messages && node.messages[0] ? node.messages[0].text : '', 'text', 'ç›¸æ‰‹ã‹ã‚‰ã®æœ€åˆã®ç™ºè¨€');
                // Add Image URL input and File Upload for initial message
                html += `
                <div class="mb-2">
                    <label class="block text-xs font-bold text-slate-600 mb-1">åˆæœŸç”»åƒ (URL ã¾ãŸã¯ ãƒ•ã‚¡ã‚¤ãƒ«)</label>
                    <div class="flex gap-2">
                        <input type="text" value="${node.initialImage || ''}" placeholder="https://..." oninput="updateNodeField('${node.id}', 'initialImage', this.value)" class="flex-1 border rounded px-3 py-2 text-sm">
                        <label class="cursor-pointer bg-slate-200 hover:bg-slate-300 text-slate-600 px-3 py-2 rounded text-sm flex items-center justify-center">
                            <i data-lucide="image" class="w-4 h-4"></i>
                            <input type="file" accept="image/*" class="hidden" onchange="handleImageUpload(event, '${node.id}')">
                        </label>
                    </div>
                </div>`;
                
                // Chat Mode Selection
                const mode = node.chatMode || 'simple';
                html += `
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-slate-600 mb-1">ãƒãƒ£ãƒƒãƒˆå‹•ä½œãƒ¢ãƒ¼ãƒ‰</label>
                        <select onchange="updateNodeField('${node.id}', 'chatMode', this.value); renderStep();" class="w-full border rounded px-3 py-2 text-sm font-bold text-indigo-700 bg-indigo-50">
                            <option value="simple" ${mode === 'simple' ? 'selected' : ''}>ã‚·ãƒŠãƒªã‚ªé€²è¡Œ (ä¸€æ–¹é€šè¡Œ)</option>
                            <option value="rule" ${mode === 'rule' ? 'selected' : ''}>ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹å¿œç­” (ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´)</option>
                            <option value="ai" ${mode === 'ai' ? 'selected' : ''}>AIå¯¾è©± (Gemini API)</option>
                        </select>
                    </div>
                `;

                if (mode === 'simple') {
                     html += `<div class="p-2 bg-slate-100 text-xs text-slate-500 rounded mb-2">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½•ã‹é€ä¿¡ã™ã‚‹ã¨ã€å³åº§ã«ã€Œæ¬¡ã®ã‚·ãƒ¼ãƒ³ã€ã¸é·ç§»ã—ã¾ã™ã€‚</div>`;
                } else if (mode === 'rule') {
                     html += `<div class="p-2 bg-blue-50 text-xs text-blue-800 rounded mb-2">è¨­å®šã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã‚‹ã¨ã€æŒ‡å®šã®è¿”ç­”ã‚’ã—ã¾ã™ã€‚<br>ä¾‹: ã€Œã‚ã‹ã‚‰ãªã„ã€â†’ã€Œæ•™ç§‘æ›¸ã‚’è¦‹ã¦ã€</div>`;
                     html += mkTextarea('ãƒ«ãƒ¼ãƒ«è¨­å®š (JSONå½¢å¼: [{"key":"å˜èª", "res":"è¿”ç­”"}, ...])', 'rules', typeof node.rules === 'string' ? node.rules : JSON.stringify(node.rules || [], null, 2));
                } else if (mode === 'ai') {
                     html += `<div class="p-2 bg-purple-50 text-xs text-purple-800 rounded mb-2">Gemini APIã‚’ä½¿ç”¨ã—ã¦ã€æ–‡è„ˆã«å¿œã˜ãŸè¿”ç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</div>`;
                     html += mkInput('ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«å', 'modelName', node.modelName || 'gemini-2.5-flash', 'text', 'ä¾‹: gemini-2.5-flash, gemini-1.5-flash');
                     html += `<p class="text-[10px] text-slate-500 mb-2">â€» ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ 'gemini-2.5-flash' ã§ã™ã€‚</p>`;
                     
                     html += mkTextarea('ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ (AIã®äººæ ¼ãƒ»å½¹å‰²)', 'systemPrompt', node.systemPrompt);
                     html += mkInput('Google Gemini API Key', 'apiKey', node.apiKey, 'password', 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‹•ä½œã®ãŸã‚ã«å…¥åŠ›æ¨å¥¨');
                     
                     html += `
                        <div class="grid grid-cols-2 gap-2 mb-2">
                             <div>
                                <label class="block text-xs font-bold text-slate-600 mb-1">çµ‚äº†æ¡ä»¶</label>
                                <select onchange="updateNodeField('${node.id}', 'exitCondition', this.value)" class="w-full border rounded px-3 py-2 text-sm">
                                    <option value="count" ${node.exitCondition === 'count' ? 'selected' : ''}>ä¼šè©±å›æ•°</option>
                                    <option value="keyword" ${node.exitCondition === 'keyword' ? 'selected' : ''}>ç‰¹å®šãƒ¯ãƒ¼ãƒ‰ã‚’å¼•ãå‡ºã™</option>
                                </select>
                             </div>
                             <div>
                                <label class="block text-xs font-bold text-slate-600 mb-1">æ¡ä»¶å€¤</label>
                                <input type="text" value="${node.exitValue || ''}" oninput="updateNodeField('${node.id}', 'exitValue', this.value)" class="w-full border rounded px-3 py-2 text-sm" placeholder="å›æ•° or ãƒ¯ãƒ¼ãƒ‰">
                             </div>
                        </div>
                     `;
                }

            } else if (node.type === 'result') {
                html += `<div class="mb-2"><label class="flex items-center gap-2"><input type="checkbox" ${node.isGood ? 'checked' : ''} onchange="updateNodeField('${node.id}', 'isGood', this.checked)"> Good End</label></div>`;
                html += mkTextarea('çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸', 'message', node.message);
            }
            return html;
        }

        // --- STEP 4: Paper Materials (Old Step 6) ---
        function renderPaperMaterials(container) {
            const p = projectData;
            const o = p.onboarding;

            // Generate Rubric Table HTML for preview
            const rubricRows = p.ice.rubricMatrix.map(r => `
                <tr>
                    <td>${r.category}</td>
                    <td>${r.i_text} (${r.i_score}ç‚¹)</td>
                    <td>${r.c_text} (${r.c_score}ç‚¹)</td>
                    <td>${r.e_text} (${r.e_score}ç‚¹)</td>
                </tr>
            `).join('');

            container.innerHTML = `
                <div class="flex gap-8 h-full">
                    <!-- Editor Side -->
                    <div class="w-1/3 bg-white p-6 rounded-lg shadow-sm overflow-y-auto border border-slate-200 h-full">
                        <h3 class="font-bold text-lg mb-4">é…å¸ƒè³‡æ–™ã®ç·¨é›†</h3>
                        
                        <div class="space-y-6">
                            <div class="border-b pb-4">
                                <h4 class="text-sm font-bold text-indigo-600 mb-2">ç”¨ç´™1: å­¦ç¿’ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹</h4>
                                <label class="block text-xs font-bold text-slate-600 mb-1">ã‚¿ã‚¤ãƒˆãƒ«</label>
                                <input type="text" class="w-full border rounded px-2 py-1 text-sm mb-2" value="${o.paper1.title}" oninput="projectData.onboarding.paper1.title=this.value; renderStep6Preview()">
                                
                                <label class="block text-xs font-bold text-slate-600 mb-1">å†…å®¹ç‰©ãƒªã‚¹ãƒˆ</label>
                                <textarea class="w-full border rounded px-2 py-1 text-sm h-16 mb-2" oninput="projectData.onboarding.paper1.contents=this.value; renderStep6Preview()">${o.paper1.contents}</textarea>
                                
                                <label class="block text-xs font-bold text-slate-600 mb-1">éŠã³æ–¹</label>
                                <textarea class="w-full border rounded px-2 py-1 text-sm h-24" oninput="projectData.onboarding.paper1.howToPlay=this.value; renderStep6Preview()">${o.paper1.howToPlay}</textarea>
                            </div>

                            <div>
                                <h4 class="text-sm font-bold text-indigo-600 mb-2">ç”¨ç´™2: ã‚²ãƒ¼ãƒ ã®å…¥ã‚Šå£ (é»’èƒŒæ™¯)</h4>
                                <label class="block text-xs font-bold text-slate-600 mb-1">ã‚¿ã‚¤ãƒˆãƒ«</label>
                                <input type="text" class="w-full border rounded px-2 py-1 text-sm mb-2" value="${o.paper2.title}" oninput="projectData.onboarding.paper2.title=this.value; renderStep6Preview()">
                                
                                <label class="block text-xs font-bold text-slate-600 mb-1">ã‚¹ãƒˆãƒ¼ãƒªãƒ¼æ¦‚è¦</label>
                                <textarea class="w-full border rounded px-2 py-1 text-sm h-24 mb-2" oninput="projectData.onboarding.paper2.story=this.value; renderStep6Preview()">${o.paper2.story}</textarea>
                                
                                <label class="block text-xs font-bold text-slate-600 mb-1">å­¦ç¿’è€…ã®å½¹å‰²</label>
                                <input type="text" class="w-full border rounded px-2 py-1 text-sm mb-2" value="${o.paper2.role}" oninput="projectData.onboarding.paper2.role=this.value; renderStep6Preview()">
                                
                                <label class="block text-xs font-bold text-slate-600 mb-1">æœ€åˆã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</label>
                                <textarea class="w-full border rounded px-2 py-1 text-sm h-16 mb-2" oninput="projectData.onboarding.paper2.action=this.value; renderStep6Preview()">${o.paper2.action}</textarea>
                                
                                <label class="block text-xs font-bold text-slate-600 mb-1">ã‚²ãƒ¼ãƒ å…¬é–‹ç”¨URL (QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆå…ƒ)</label>
                                <input type="text" class="w-full border rounded px-2 py-1 text-sm text-indigo-600 font-bold" value="${o.paper2.qrUrl}" oninput="projectData.onboarding.paper2.qrUrl=this.value; renderStep6Preview()" placeholder="https://...">
                                <p class="text-[10px] text-slate-500 mt-1">â€»ã“ã“ã«ã‚²ãƒ¼ãƒ ã‚’å…¬é–‹ã™ã‚‹äºˆå®šã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚QRã‚³ãƒ¼ãƒ‰ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚</p>
                            </div>
                        </div>
                    </div>

                    <!-- Preview Side -->
                    <div class="flex-1 bg-slate-200 p-8 rounded-lg overflow-y-auto h-full flex flex-col items-center relative">
                        <div class="absolute top-4 right-4 z-10">
                            <button onclick="printPapers()" class="bg-indigo-600 text-white px-4 py-2 rounded shadow flex items-center gap-2 hover:bg-indigo-700">
                                <i data-lucide="printer"></i> A4ç”¨ç´™ã‚’å°åˆ·ã™ã‚‹
                            </button>
                        </div>

                        <div id="paper-preview-area" class="transform origin-top scale-75">
                            <!-- Paper 1 -->
                            <div class="a4-paper" id="paper1-preview">
                                <h1>${o.paper1.title}</h1>
                                
                                <h2>1. å†…å®¹ç‰©ãƒªã‚¹ãƒˆ</h2>
                                <p class="whitespace-pre-wrap">${o.paper1.contents}</p>
                                
                                <h2>2. å­¦ç¿’å†…å®¹ã¨ç›®æ¨™</h2>
                                <p><strong>ãƒ†ãƒ¼ãƒ:</strong> ${p.meta.title}</p>
                                <p><strong>ç›®æ¨™(After):</strong> ${p.goals.after}</p>

                                <h2>3. ICEãƒ«ãƒ¼ãƒ–ãƒªãƒƒã‚¯ (è©•ä¾¡è¡¨)</h2>
                                <table class="rubric-table">
                                    <thead>
                                        <tr>
                                            <th>è©•ä¾¡é …ç›®</th>
                                            <th style="color:#d97706">I: åŸºç¤</th>
                                            <th style="color:#2563eb">C: é–¢é€£</th>
                                            <th style="color:#9333ea">E: å¿œç”¨</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${rubricRows}
                                    </tbody>
                                </table>

                                <h2>4. éŠã³æ–¹</h2>
                                <p class="whitespace-pre-wrap">${o.paper1.howToPlay}</p>
                            </div>

                            <!-- Paper 2 (Dark Mode) -->
                            <div class="a4-paper dark-mode" id="paper2-preview">
                                <h1>${o.paper2.title}</h1>
                                
                                <div style="display:flex; justify-content: space-between; margin-top: 20mm;">
                                    <div style="width: 65%;">
                                        <h2>ã‚¹ãƒˆãƒ¼ãƒªãƒ¼</h2>
                                        <p class="whitespace-pre-wrap">${o.paper2.story}</p>
                                        
                                        <h2>ã‚ãªãŸã®å½¹å‰²</h2>
                                        <p class="text-xl font-bold text-indigo-400">${o.paper2.role}</p>
                                        
                                        <h2>æœ€åˆã®ãƒŸãƒƒã‚·ãƒ§ãƒ³</h2>
                                        <p class="whitespace-pre-wrap mission-box p-4 border-l-4 rounded">${o.paper2.action}</p>
                                    </div>
                                    <div style="width: 30%; display:flex; flex-direction: column; align-items: center; justify-content: center;">
                                        <div class="qr-container">
                                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(o.paper2.qrUrl)}" width="150" height="150">
                                        </div>
                                        <p style="text-align:center; font-size: 10pt; margin-top: 5px; font-weight: bold;">START GAME</p>
                                    </div>
                                </div>
                                
                                <div class="footer" style="margin-top: 30mm; border-top: 1px dashed; padding-top: 5mm; text-align: center; font-size: 10pt;">
                                    Produced by ${p.meta.author} | Edu-ARG Builder
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        // Simple re-render for text inputs to avoid losing focus if possible, 
        // but full re-render is safer for data sync in this simple prototype.
        // To improve, we would update DOM elements directly. For now, full render is fast enough.
        function renderStep6Preview() {
             renderPaperMaterials(document.getElementById('editor-content'));
            // Focus restoration logic could be added here
        }

        function printPapers() {
            const content = document.getElementById('paper-preview-area').innerHTML;
            const win = window.open('', '', 'width=1000,height=800');
            win.document.write(`
                <html>
                <head>
                    <title>Print Materials</title>
                    <style>
                        body { font-family: sans-serif; background: #ccc; padding: 20px; }
                        .a4-paper {
                            width: 210mm; height: 297mm; background: white;
                            padding: 15mm; margin: 0 auto 10mm auto;
                            box-shadow: 0 0 10px rgba(0,0,0,0.1);
                            page-break-after: always;
                            box-sizing: border-box;
                        }
                        .a4-paper:last-child { page-break-after: avoid; }
                        h1 { font-size: 24pt; font-weight: bold; margin-bottom: 10mm; text-align: center; border-bottom: 2px solid #333; padding-bottom: 5mm; }
                        h2 { font-size: 16pt; font-weight: bold; margin-top: 8mm; margin-bottom: 4mm; border-left: 5px solid #6366f1; padding-left: 3mm; }
                        h3 { font-size: 12pt; font-weight: bold; margin-top: 5mm; margin-bottom: 2mm; }
                        p { margin-bottom: 4mm; text-align: justify; line-height: 1.6; font-size: 11pt; }
                        .whitespace-pre-wrap { white-space: pre-wrap; }
                        .rubric-table { width: 100%; border-collapse: collapse; margin-top: 5mm; font-size: 9pt; }
                        .rubric-table th, .rubric-table td { border: 1px solid #333; padding: 2mm; }
                        .rubric-table th { background-color: #f0f0f0; text-align: center; }
                        
                        /* Dark Mode Styles for Print */
                        .a4-paper.dark-mode {
                            background-color: #0f172a !important;
                            color: #e2e8f0 !important;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        .a4-paper.dark-mode h1 { border-bottom-color: #e2e8f0; }
                        .a4-paper.dark-mode h2 { border-left-color: #818cf8; }
                        .a4-paper.dark-mode .qr-container { background-color: white; padding: 10px; border: 4px solid #e2e8f0; }
                        .a4-paper.dark-mode .mission-box { background-color: #1e293b; border-left: 4px solid #818cf8; color: #e2e8f0; padding: 1rem; }
                        .a4-paper.dark-mode .footer { border-top-color: #475569; color: #64748b; }
                        
                        .text-xl { font-size: 1.25rem; }
                        .font-bold { font-weight: 700; }
                        .text-indigo-400 { color: #818cf8; }
                        
                        @media print {
                            body { background: none; padding: 0; }
                            .a4-paper { box-shadow: none; margin: 0; width: 100%; height: 100%; }
                            @page { size: A4; margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${content}
                    <script>
                        window.onload = function() { window.print(); window.close(); }
                    <\/script>
                </body>
                </html>
            `);
            win.document.close();
        }


        // --- STEP 5: Build (Old Step 7) ---
        function renderBuildScreen(container) {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center max-w-lg mx-auto">
                    <div class="bg-indigo-100 p-6 rounded-full mb-6">
                        <i data-lucide="package" class="w-12 h-12 text-indigo-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">ã‚²ãƒ¼ãƒ ã®ãƒ“ãƒ«ãƒ‰æº–å‚™å®Œäº†</h2>
                    <p class="text-slate-500 mb-8">
                        ã“ã‚Œã¾ã§ã®è¨­å®šã«åŸºã¥ãã€ãƒ—ãƒ¬ã‚¤å¯èƒ½ãªå˜ä¸€HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™ã€‚<br>
                        AIã«ã‚ˆã‚‹è‡ªå‹•æ¡ç‚¹æ©Ÿèƒ½ã‚’æ­è¼‰ã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã™ã€‚
                    </p>
                    
                    <button type="button" onclick="downloadGame()" class="bg-indigo-600 text-white px-8 py-4 rounded-lg font-bold shadow-lg hover:bg-indigo-700 transition flex items-center gap-3 text-lg transform hover:scale-105">
                        <i data-lucide="download"></i> ã‚²ãƒ¼ãƒ ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (.html)
                    </button>

                    <div class="mt-8 p-4 bg-slate-100 rounded text-left text-xs text-slate-500 w-full">
                        <strong>ãƒ“ãƒ«ãƒ‰å†…å®¹:</strong><br>
                        - ãƒãƒ¼ãƒ‰æ•°: ${projectData.nodes.length}<br>
                        - AIãƒãƒ£ãƒƒãƒˆå®Ÿè£…: ${projectData.nodes.some(n => n.type === 'chat' && n.chatMode === 'ai') ? 'ã‚ã‚Š (Gemini)' : 'ãªã—'}<br>
                        - ãƒ«ãƒ¼ãƒ–ãƒªãƒƒã‚¯é …ç›®æ•°: ${projectData.ice.rubricMatrix ? projectData.ice.rubricMatrix.length : 0}é …ç›®<br>
                        - åˆè¨ˆã‚µã‚¤ã‚º: æ¨å®š 35KB
                    </div>
                </div>
            `;
            lucide.createIcons();
        }
        // ... (Data Manipulation & Game Logic Functions remain same as before) ...

        // --- DATA MANIPULATION ---

        function selectNode(id) {
            selectedNodeId = id;
            previewChatHistory = []; // Reset history on node change
            renderStep();
        }

        function addNode() {
            const newId = `n${Date.now().toString().slice(-4)}`;
            projectData.nodes.push({ id: newId, type: 'search', title: 'New Scene', next: '' });
            selectedNodeId = newId;
            renderStep();
        }

        function moveNode(index, direction) {
            if (direction === -1 && index > 0) {
                // Move Up
                const temp = projectData.nodes[index];
                projectData.nodes[index] = projectData.nodes[index - 1];
                projectData.nodes[index - 1] = temp;
            } else if (direction === 1 && index < projectData.nodes.length - 1) {
                // Move Down
                const temp = projectData.nodes[index];
                projectData.nodes[index] = projectData.nodes[index + 1];
                projectData.nodes[index + 1] = temp;
            }
            renderStep();
        }

        function deleteNode(id) {
            if(projectData.nodes.length <= 1) return alert("æœ€å¾Œã®ãƒãƒ¼ãƒ‰ã¯å‰Šé™¤ã§ãã¾ã›ã‚“");
            projectData.nodes = projectData.nodes.filter(n => n.id !== id);
            selectedNodeId = projectData.nodes[0].id;
            renderStep();
        }

        function updateNodeField(id, key, value) {
            const node = projectData.nodes.find(n => n.id === id);
            if(node) {
                node[key] = value;
                updatePreview(); // Real-time update
            }
        }
        
        function updateNodeType(id, newType) {
            const node = projectData.nodes.find(n => n.id === id);
            if(node) {
                node.type = newType;
                // Add default fields if missing logic here...
                renderStep();
            }
        }

        // --- PREVIEW LOGIC (SIMULATED OS UI) ---

        function updatePreview() {
            const screen = document.getElementById('preview-screen');
            const node = projectData.nodes.find(n => n.id === selectedNodeId);
            if (!node) return;

            // Date/Time Formatting for Preview
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            // For date, keeping it slightly stylized or localized
            const dateStr = now.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });

            // Common OS Header
            const header = `
                <div class="h-6 bg-transparent flex justify-between items-center px-4 pt-1 z-20 absolute w-full top-1 text-xs font-bold ${node.type === 'os_home' ? 'text-white' : 'text-black'}">
                    <span>${timeStr}</span>
                    <div class="flex gap-1">
                        <i data-lucide="wifi" class="w-3 h-3"></i>
                        <i data-lucide="battery" class="w-3 h-3"></i>
                    </div>
                </div>
            `;

            let content = '';

            // Render content based on type
            if (node.type === 'os_home') {
                content = `
                    <div class="h-full w-full bg-gradient-to-b from-blue-400 to-indigo-600 flex flex-col p-4 pt-12">
                        <div class="flex-1"></div>
                        <div class="grid grid-cols-4 gap-4 mb-4">
                            ${['mail', 'browser', 'calendar', 'camera', 'photos', 'maps', 'notes', 'settings'].map(icon => `
                                <div class="flex flex-col items-center gap-1">
                                    <div class="w-14 h-14 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center text-white">
                                        <i data-lucide="${icon === 'browser' ? 'globe' : icon}" class="w-6 h-6"></i>
                                    </div>
                                    <span class="text-[10px] text-white capitalize">${icon}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="bg-white/20 backdrop-blur rounded-3xl p-4 grid grid-cols-4 gap-4">
                             ${['phone', 'message-circle', 'search', 'music'].map(icon => `
                                <div class="flex flex-col items-center gap-1">
                                    <div class="w-14 h-14 ${icon === 'phone' ? 'bg-green-500' : icon === 'message-circle' ? 'bg-green-400' : 'bg-white'} rounded-xl flex items-center justify-center shadow-lg">
                                        <i data-lucide="${icon}" class="w-6 h-6 ${['phone','message-circle','mail'].includes(icon) ? 'text-white' : 'text-slate-800'}"></i>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else if (node.type === 'search') {
                content = `
                    <div class="bg-white h-full flex flex-col pt-8">
                        <div class="flex flex-col items-center mt-20 px-6">
                            <h1 class="text-3xl font-bold text-slate-700 mb-6"><span class="text-blue-500">G</span>oogle</h1>
                            <div class="w-full h-12 rounded-full border border-slate-300 shadow-sm flex items-center px-4 gap-2">
                                <i data-lucide="search" class="text-slate-400 w-5 h-5"></i>
                                <span class="text-slate-400">${node.query || 'æ¤œç´¢...'}</span>
                            </div>
                            <div class="mt-8 bg-blue-50 text-blue-800 p-4 rounded text-sm w-full border border-blue-100">
                                <strong>ãƒ’ãƒ³ãƒˆ:</strong> ${node.hint || '...'}
                            </div>
                        </div>
                    </div>
                `;
            } else if (node.type === 'web') {
                content = `
                    <div class="bg-white h-full flex flex-col pt-8">
                        <div class="bg-slate-100 border-b p-2 text-xs text-center flex items-center justify-center gap-2 text-slate-500">
                            <i data-lucide="lock" class="w-3 h-3"></i> ${node.url || 'website.com'}
                        </div>
                        <div class="flex-1 overflow-y-auto">
                            ${node.html || 'No Content'}
                        </div>
                    </div>
                `;
            } else if (node.type === 'phone') {
                content = `
                    <div class="bg-slate-900 h-full flex flex-col items-center pt-24 text-white relative overflow-hidden">
                        <div class="w-24 h-24 rounded-full bg-slate-700 flex items-center justify-center mb-4">
                            <i data-lucide="user" class="w-10 h-10 text-slate-400"></i>
                        </div>
                        <h2 class="text-2xl font-light">${node.caller || 'Unknown'}</h2>
                        <p class="text-sm text-slate-400 mt-1">ãƒ¢ãƒã‚¤ãƒ«éŸ³å£°é€šè©±...</p>
                        
                        <div class="absolute bottom-20 w-full flex justify-around px-12">
                            <div class="flex flex-col items-center gap-2">
                                <div class="w-16 h-16 rounded-full bg-red-500 flex items-center justify-center animate-pulse">
                                    <i data-lucide="phone-off" class="w-8 h-8"></i>
                                </div>
                                <span class="text-xs">æ‹’å¦</span>
                            </div>
                            <div class="flex flex-col items-center gap-2">
                                <div class="w-16 h-16 rounded-full bg-green-500 flex items-center justify-center animate-bounce">
                                    <i data-lucide="phone" class="w-8 h-8"></i>
                                </div>
                                <span class="text-xs">å¿œç­”</span>
                            </div>
                        </div>
                    </div>
                `;
            } else if (node.type === 'email') {
                content = `
                    <div class="bg-white h-full flex flex-col pt-8">
                        <div class="bg-slate-50 border-b px-4 py-3">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-blue-600 text-sm">å—ä¿¡ãƒˆãƒ¬ã‚¤ (1)</span>
                                <span class="text-xs text-slate-400">ç·¨é›†</span>
                            </div>
                            <h1 class="font-bold text-xl">Mail</h1>
                        </div>
                        <div class="p-4 border-b border-slate-100 bg-blue-50/50">
                            <div class="flex justify-between mb-1">
                                <span class="font-bold text-sm">${node.sender || 'Sender'}</span>
                                <span class="text-xs text-slate-400">ä»Š</span>
                            </div>
                            <div class="font-bold text-sm mb-1">${node.subject || 'Subject'}</div>
                            <div class="text-xs text-slate-500 line-clamp-2">${node.body || 'Body text...'}</div>
                        </div>
                        <div class="p-4 bg-white flex-1">
                            <p class="text-sm text-slate-800 leading-relaxed whitespace-pre-wrap">${node.body}</p>
                            ${node.linkText ? `<button class="mt-4 w-full bg-blue-600 text-white py-2 rounded font-bold text-sm">${node.linkText}</button>` : ''}
                        </div>
                    </div>
                `;
            } else if (node.type === 'chat') {
                 const initialMsg = node.messages && node.messages[0] ? node.messages[0] : {text: "ã“ã‚“ã«ã¡ã¯"};
                 const isAI = node.chatMode === 'ai';
                 const isRule = node.chatMode === 'rule';

                 // Merge initial message with local preview history if empty
                 if(previewChatHistory.length === 0) {
                     if(initialMsg.text) {
                         previewChatHistory.push({sender: 'them', text: initialMsg.text});
                     }
                     if(node.initialImage) {
                         previewChatHistory.push({sender: 'them', image: node.initialImage});
                     }
                 }
                 
                 const apiKeyField = isAI && !node.apiKey ? '<div class="px-3 py-1 bg-yellow-100 text-[10px] text-yellow-700 mb-2">Preview: API Key required</div><input type="password" id="preview-api-key" placeholder="Enter Gemini API Key here for Preview" class="w-full border p-1 mb-2 rounded text-xs">' : '';

                 // Generate bubbles HTML
                 let bubblesHtml = previewChatHistory.map(m => {
                    let content = '';
                    if(m.image) {
                        content = `<img src="${m.image}" class="rounded-lg max-w-full h-auto mb-1 border border-slate-200">`;
                    } else if (m.text) {
                        // Split text by newline and create separate bubbles
                        const lines = m.text.split('\n');
                        return lines.map(line => {
                             if(!line.trim()) return '';
                             return `
                                <div class="flex gap-2 ${m.sender === 'me' ? 'flex-row-reverse' : ''} mb-2">
                                    <div class="w-8 h-8 rounded-full ${m.sender === 'me' ? 'bg-indigo-500' : 'bg-slate-300'} flex-shrink-0"></div>
                                    <div class="p-3 rounded-lg shadow-sm text-sm max-w-[80%] ${m.sender === 'me' ? 'bg-indigo-500 text-white rounded-tr-none' : 'bg-white rounded-tl-none'}">${line}</div>
                                </div>
                            `;
                        }).join('');
                    }
                    
                    if(m.image) {
                         return `
                            <div class="flex gap-2 ${m.sender === 'me' ? 'flex-row-reverse' : ''} mb-2">
                                <div class="w-8 h-8 rounded-full ${m.sender === 'me' ? 'bg-indigo-500' : 'bg-slate-300'} flex-shrink-0"></div>
                                <div class="p-2 rounded-lg shadow-sm text-sm max-w-[80%] bg-white rounded-tl-none">${content}</div>
                            </div>
                        `;
                    }
                    return content; // Fallback
                 }).join('');

                 content = `
                    <div class="bg-slate-100 h-full flex flex-col pt-10">
                         <div class="bg-white p-3 shadow-sm flex items-center gap-2 z-10">
                            <i data-lucide="arrow-left" class="w-5 h-5 text-blue-500"></i> 
                            <span class="font-bold flex-1">${node.partner}</span>
                            ${isAI ? '<span class="text-[10px] bg-purple-100 text-purple-600 px-1 rounded">AI (Preview)</span>' : ''}
                            ${isRule ? '<span class="text-[10px] bg-blue-100 text-blue-600 px-1 rounded">BOT</span>' : ''}
                         </div>
                         <div id="preview-chat-messages" class="flex-1 p-4 overflow-y-auto pb-4">
                            ${apiKeyField}
                            ${bubblesHtml}
                         </div>
                         <div class="p-3 bg-white border-t flex gap-2">
                            <input type="text" id="preview-chat-input" class="flex-1 border rounded-full px-4 text-sm" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" onkeydown="if(event.key === 'Enter') previewChatSend()">
                            <button onclick="previewChatSend()" class="bg-blue-500 text-white rounded-full p-2 hover:bg-blue-600"><i data-lucide="send" class="w-4 h-4"></i></button>
                         </div>
                    </div>
                `;
            } else {
                content = `<div class="h-full flex items-center justify-center bg-slate-50 text-slate-400">Preview not detailed for type: ${node.type}</div>`;
            }

            screen.innerHTML = header + content;
            lucide.createIcons();
            
            // Auto scroll preview
            if(node.type === 'chat') {
                const el = document.getElementById('preview-chat-messages');
                if(el) el.scrollTop = el.scrollHeight;
            }
        }

        // --- PREVIEW INTERACTIVITY ---

        async function previewChatSend() {
            const inputEl = document.getElementById('preview-chat-input');
            const text = inputEl.value;
            if(!text) return;

            const node = projectData.nodes.find(n => n.id === selectedNodeId);
            if(!node) return;

            // Add user message to preview
            previewChatHistory.push({sender: 'me', text: text});
            inputEl.value = '';
            updatePreview();

            let replyText = "...";

            if (node.chatMode === 'simple') {
                replyText = "(ã‚·ãƒŠãƒªã‚ªé€²è¡Œãƒ¢ãƒ¼ãƒ‰: ã“ã“ã§æ¬¡ã®ã‚·ãƒ¼ãƒ³ã¸é·ç§»ã—ã¾ã™)";
            } 
            else if (node.chatMode === 'rule') {
                const rules = typeof node.rules === 'string' ? JSON.parse(node.rules || '[]') : (node.rules || []);
                const match = rules.find(r => text.includes(r.key));
                replyText = match ? match.res : "ãªã‚‹ã»ã©ã€ä»–ã«ã¯ï¼Ÿ"; 
            } 
            else if (node.chatMode === 'ai') {
                // Fetch API Key from Node settings OR Preview input
                let key = node.apiKey;
                const previewKeyInput = document.getElementById('preview-api-key');
                if(!key && previewKeyInput) key = previewKeyInput.value;

                if(!key) {
                    replyText = "[System] APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒãƒ¼ãƒ‰è¨­å®šã¾ãŸã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å…¥åŠ›æ¬„ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
                } else {
                    try {
                         // Loading indicator
                        previewChatHistory.push({sender: 'them', text: "..."});
                        updatePreview();
                        
                        const model = node.modelName || 'gemini-2.5-flash';
                        
                        // Build Dynamic System Prompt
                        const finalSystemPrompt = generateIceSystemPrompt(node);

                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [
                                    { role: "user", parts: [{ text: finalSystemPrompt + "\n\nUser says: " + text }] }
                                ]
                            })
                        });
                        const data = await response.json();
                        // Remove loading ...
                        previewChatHistory.pop();
                        
                        if(data.error) {
                             replyText = "API Error: " + data.error.message;
                        } else {
                             let rawText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Error: No response";
                             if (rawText.includes('[[END]]')) {
                                rawText = rawText.replace('[[END]]', '').trim() + " (çµ‚äº†ã‚·ã‚°ãƒŠãƒ«æ¤œçŸ¥: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯ã“ã“ã¾ã§)";
                             }
                             replyText = rawText;
                        }
                    } catch(e) {
                        previewChatHistory.pop();
                        replyText = "Network Error: " + e.message;
                    }
                }
            }

            // Simulate delay
            setTimeout(() => {
                previewChatHistory.push({sender: 'them', text: replyText});
                updatePreview();
            }, 500);
        }

        // --- GAME BUILDER (STEP 7) ---

        function downloadGame() {
            try {
                // Generate the standalone HTML string
                const htmlContent = generatePlayableHTML(projectData);
                
                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `edu_arg_${Date.now()}.html`;
                
                document.body.appendChild(a);
                a.click();
                
                // Cleanup
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            } catch (e) {
                console.error("Download failed:", e);
                alert("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
            }
        }

        function generatePlayableHTML(data) {
            // NOTE: Double escaping backslashes (\\) and template literals (\${}) is crucial here.

            const scriptContent = `
        const gameData = ${JSON.stringify(data)};
        let currentNodeId = gameData.nodes[0].id;
        let chatHistory = [];
        let chatCount = 0;
        let gameScore = 0;
        let scoreDetails = {};
        let pendingNode = null; // For Notification Wait
        let notificationArrived = false;
        
        // --- GAME ENGINE ---
        
        // Global App Opener
        window.openApp = function(nodeId) {
            if(!nodeId) {
                alert('ã‚¢ãƒ—ãƒªãŒé–‹ã‘ã¾ã›ã‚“');
                return;
            }
            
            // é€šçŸ¥å¾…ã¡çŠ¶æ…‹ã§ã€ã¾ã é€šçŸ¥ãŒæ¥ã¦ã„ãªã„å ´åˆã¯åå¿œã—ãªã„
            if (pendingNode && pendingNode.id === nodeId && !notificationArrived) {
                return; 
            }
            
            pendingNode = null; 
            notificationArrived = false;
            currentNodeId = nodeId; // ç›´æ¥é·ç§»
            render();
        };

        // Date Format Helper
        function getFormattedTime() {
            const now = new Date();
            return now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        }
        function getFormattedDate() {
            const now = new Date();
            return now.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
        }

        function render() {
            const root = document.getElementById('app-root');
            
            // Virtual Home State (Waiting for app open)
            if(currentNodeId === 'virtual_home') {
                renderVirtualHome(root);
                return;
            }

            const node = gameData.nodes.find(n => n.id === currentNodeId);
            if(!node) return root.innerHTML = '<div class="p-10">Error: Node not found</div>';

            // Reset chat history when entering new chat node
            if(node.type === 'chat' && chatHistory.length === 0) {
                 if(node.messages && node.messages[0] && node.messages[0].text) {
                     chatHistory.push({sender: 'them', text: node.messages[0].text});
                 }
                 if(node.initialImage) {
                     chatHistory.push({sender: 'them', image: node.initialImage});
                 }
                 chatCount = 0;
            } else if (node.type !== 'chat') {
                chatHistory = [];
            }

            let html = '';
            // Status Bar with Realtime Clock
            const timeStr = getFormattedTime();
            
            html += '<div class="h-6 bg-white/0 absolute w-full top-0 flex justify-between px-4 pt-1 z-50 text-xs font-bold pointer-events-none ' + (node.type === 'os_home' ? 'text-white' : 'text-slate-800') + '"><span>' + timeStr + '</span><span>100%</span></div>';

            // Main Content Area
            html += '<div class="w-full h-full fade-in relative">';
            
            if(node.type === 'os_home') {
                html += getHomeHTML(node);
            } 
            else if(node.type === 'search') {
                html += \`
                    <div class="bg-white h-full flex flex-col pt-12 px-6">
                        <div class="text-center mb-8"><span class="text-4xl font-bold text-slate-700"><span class="text-blue-500">G</span>oogle</span></div>
                        <input type="text" id="search-input" class="w-full border border-slate-300 rounded-full py-3 px-5 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="æ¤œç´¢...">
                        <button onclick="handleSearch()" class="mt-4 bg-slate-100 text-slate-600 px-6 py-2 rounded text-sm mx-auto hover:bg-slate-200">Google æ¤œç´¢</button>
                        <div class="mt-10 p-4 bg-yellow-50 text-yellow-800 text-xs rounded border border-yellow-100">Hint: \${node.hint}</div>
                    </div>
                \`;
            }
            else if(node.type === 'web') {
                html += \`
                    <div class="bg-white h-full flex flex-col pt-8">
                        <div class="bg-slate-100 border-b p-2 flex items-center gap-2 text-xs text-slate-500 px-4">
                            <i data-lucide="lock" class="w-3 h-3"></i> <div class="bg-white px-2 py-1 rounded flex-1">\${node.url}</div>
                        </div>
                        <div class="flex-1 overflow-y-auto relative">
                            \${node.html}
                        </div>
                    </div>
                \`;
            }
            else if(node.type === 'form') {
                html += \`
                    <div class="bg-white h-full flex flex-col pt-8 overflow-y-auto">
                        <div class="bg-slate-800 text-white p-4"><h2 class="font-bold">å¿œå‹Ÿãƒ•ã‚©ãƒ¼ãƒ </h2></div>
                        <div class="p-6 space-y-4">
                            <div><label class="text-xs font-bold text-slate-500">æ°å</label><input type="text" class="w-full border p-2 rounded"></div>
                            <div><label class="text-xs font-bold text-slate-500">å¿—æœ›å‹•æ©Ÿ</label><textarea class="w-full border p-2 rounded h-24"></textarea></div>
                            <button onclick="handleFormSubmit('\${node.next}')" class="w-full bg-orange-500 text-white font-bold py-3 rounded-lg shadow mt-4 hover:bg-orange-600">\${node.submitText}</button>
                        </div>
                    </div>
                \`;
            }
            else if(node.type === 'delay') {
                 html += \`<div class="h-full bg-black flex items-center justify-center"><div class="w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin"></div></div>\`;
                 setTimeout(() => triggerNext(node.next), node.duration || 2000);
            }
            else if(node.type === 'phone') {
                html += \`
                    <div class="bg-slate-900 h-full flex flex-col items-center pt-24 text-white">
                        <div class="animate-pulse mb-4 text-slate-300 text-sm">ç€ä¿¡ä¸­...</div>
                        <div class="w-24 h-24 rounded-full bg-slate-700 flex items-center justify-center mb-6">
                            <i data-lucide="user" class="w-12 h-12 text-slate-400"></i>
                        </div>
                        <h2 class="text-3xl font-light mb-2">\${node.caller}</h2>
                        
                        <div class="absolute bottom-20 w-full flex justify-around px-12">
                             <div class="flex flex-col items-center gap-2" onclick="startCall()">
                                <div class="w-16 h-16 rounded-full bg-green-500 flex items-center justify-center animate-bounce cursor-pointer">
                                    <i data-lucide="phone" class="w-8 h-8"></i>
                                </div>
                                <span class="text-xs">å¿œç­”</span>
                            </div>
                        </div>
                        <div id="call-active-ui" class="hidden absolute inset-0 bg-slate-800 flex flex-col items-center justify-center z-20">
                            <div class="text-green-400 mb-4">é€šè©±ä¸­ 00:01</div>
                            <div class="px-8 text-center text-slate-300 italic">"\${node.script}"</div>
                        </div>
                    </div>
                \`;
            }
            else if(node.type === 'email') {
                html += \`
                    <div class="bg-white h-full flex flex-col pt-8">
                        <div class="bg-slate-50 border-b p-4 flex justify-between items-center">
                            <span class="text-blue-600 font-bold" onclick="alert('æˆ»ã‚Œã¾ã›ã‚“')">ï¼œ å—ä¿¡ç®±</span>
                        </div>
                        <div class="p-5">
                            <h1 class="font-bold text-lg mb-4">\${node.subject}</h1>
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold">\${node.sender[0]}</div>
                                <div><div class="text-sm font-bold">\${node.sender}</div><div class="text-xs text-slate-400">To: è‡ªåˆ†</div></div>
                            </div>
                            <div class="text-slate-800 leading-relaxed whitespace-pre-wrap text-sm">\${node.body}</div>
                            \${node.linkText ? \`<button onclick="triggerNext('\${node.next}')" class="mt-8 w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow hover:bg-blue-700">\${node.linkText}</button>\` : ''}
                        </div>
                    </div>
                \`;
            }
             else if(node.type === 'video') {
                html += \`
                    <div class="bg-slate-900 h-full relative">
                         <img src="\${node.image}" class="w-full h-full object-cover opacity-80">
                         <div class="absolute bottom-0 w-full h-40 bg-gradient-to-t from-black/90 to-transparent p-6">
                            <div class="text-white font-bold text-lg mb-1">\${node.streamName}</div>
                             <div class="text-white/80 text-sm italic mb-4">"\${node.script}"</div>
                             <div class="flex gap-4 justify-center">
                                <button class="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center text-white"><i data-lucide="mic-off"></i></button>
                                <button class="w-12 h-12 rounded-full bg-red-600 flex items-center justify-center text-white" onclick="triggerNext('\${node.next}')"><i data-lucide="phone-off"></i></button>
                             </div>
                         </div>
                    </div>
                \`;
            }
             else if(node.type === 'chat') {
                 // Enhanced Chat
                 const apiKeyField = node.chatMode === 'ai' && !node.apiKey ? '<div class="px-4 py-2 bg-yellow-50 text-xs text-yellow-700 mb-2">API Key Required</div><input type="password" id="user-api-key" placeholder="Gemini API Key" class="w-full border p-2 mb-2 rounded text-xs">' : '';
                 const forceEndBtn = node.chatMode === 'ai' ? '<button onclick="evaluateChat(gameData.nodes.find(n => n.id === currentNodeId))" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded ml-auto">ä¼šè©±çµ‚äº†</button>' : '';

                 const bubblesHtml = chatHistory.map(m => {
                    let content = '';
                    if(m.image) {
                         return \`
                            <div class="flex gap-2 \${m.sender === 'me' ? 'flex-row-reverse' : ''} mb-2">
                                <div class="w-8 h-8 rounded-full \${m.sender === 'me' ? 'bg-indigo-500' : 'bg-slate-300'} flex-shrink-0"></div>
                                <div class="p-2 rounded-lg shadow-sm text-sm max-w-[80%] bg-white rounded-tl-none">
                                    <img src="\${m.image}" class="rounded-lg max-w-full h-auto border border-slate-200">
                                </div>
                            </div>
                        \`;
                    } else if (m.text) {
                        // Split text by newline
                        const lines = m.text.split('\\n');
                        return lines.map(line => {
                             if(!line.trim()) return '';
                             return \`
                                <div class="flex gap-2 \${m.sender === 'me' ? 'flex-row-reverse' : ''} mb-1">
                                    <div class="w-8 h-8 rounded-full \${m.sender === 'me' ? 'bg-indigo-500' : 'bg-slate-300'} flex-shrink-0"></div>
                                    <div class="p-3 rounded-lg shadow-sm text-sm max-w-[80%] \${m.sender === 'me' ? 'bg-indigo-500 text-white rounded-tr-none' : 'bg-white rounded-tl-none'}">\${line}</div>
                                </div>
                            \`;
                        }).join('');
                    }
                    return '';
                 }).join('');

                html += \`
                    <div class="bg-slate-100 h-full flex flex-col pt-10">
                         <div class="bg-white p-3 shadow-sm flex items-center gap-2 z-10">
                            <i data-lucide="arrow-left" class="w-5 h-5 text-blue-500"></i> 
                            <span class="font-bold">\${node.partner}</span>
                            \${forceEndBtn}
                         </div>
                         
                         <div id="chat-messages" class="flex-1 p-4 overflow-y-auto pb-20">
                             \${apiKeyField}
                             \${bubblesHtml}
                         </div>

                         <div class="p-3 bg-white border-t flex gap-2 fixed bottom-0 w-full max-w-[400px]">
                            <input type="text" id="chat-input" class="flex-1 border rounded-full px-4 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›">
                            <button onclick="handleChatSend()" class="bg-blue-500 text-white rounded-full p-2 hover:bg-blue-600"><i data-lucide="send" class="w-4 h-4"></i></button>
                         </div>
                         <div id="chat-loading" class="hidden absolute inset-0 bg-black/20 z-50 flex items-center justify-center">
                            <div class="bg-white p-4 rounded shadow-lg text-xs font-bold flex items-center gap-2"><div class="w-4 h-4 border-2 border-blue-500 rounded-full animate-spin border-t-transparent"></div>æ¡ç‚¹ä¸­...</div>
                         </div>
                    </div>
                \`;
            }
            else if(node.type === 'result') {
                 // Rubric Table Generation
                 let rubricTable = '';
                 if(gameData.ice && gameData.ice.rubricMatrix && gameData.ice.rubricMatrix.length > 0) {
                     // Inject score details if available
                     const getScore = (cat, type) => {
                         if(scoreDetails && scoreDetails.details && scoreDetails.details[cat] && scoreDetails.details[cat][type]) {
                             return '<span class="text-red-500 font-bold ml-1">(' + scoreDetails.details[cat][type] + 'ç‚¹)</span>';
                         }
                         return '';
                     }

                     rubricTable = \`
                        <div class="mt-6 w-full max-w-sm">
                            <button onclick="document.getElementById('rubric-modal').classList.remove('hidden')" class="w-full bg-white/20 hover:bg-white/30 text-white py-2 rounded text-sm font-bold border border-white/40 flex items-center justify-center gap-2">
                                <i data-lucide="table"></i> è©•ä¾¡ãƒ«ãƒ¼ãƒ–ãƒªãƒƒã‚¯ã‚’ç¢ºèª
                            </button>
                            
                            <!-- Rubric Modal -->
                            <div id="rubric-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                                <div class="bg-white text-slate-800 rounded-lg w-full max-w-lg max-h-[80vh] overflow-y-auto relative">
                                    <div class="sticky top-0 bg-white border-b p-4 flex justify-between items-center">
                                        <h3 class="font-bold text-lg">å­¦ç¿’è©•ä¾¡ãƒ«ãƒ¼ãƒ–ãƒªãƒƒã‚¯ (åˆè¨ˆ: \${gameScore}ç‚¹)</h3>
                                        <button onclick="document.getElementById('rubric-modal').classList.add('hidden')" class="p-1 hover:bg-slate-100 rounded"><i data-lucide="x" class="text-slate-500"></i></button>
                                    </div>
                                    <div class="p-4">
                                        \${scoreDetails.feedback ? \`
                                            <div class="mb-4 space-y-2">
                                                <div class="p-3 bg-green-50 border border-green-100 rounded text-xs">
                                                    <strong class="text-green-700 block mb-1">è‰¯ã‹ã£ãŸç‚¹ (Good Points):</strong>
                                                    \${scoreDetails.feedback.good || 'No feedback'}
                                                </div>
                                                <div class="p-3 bg-orange-50 border border-orange-100 rounded text-xs">
                                                    <strong class="text-orange-700 block mb-1">ã‚¢ãƒ‰ãƒã‚¤ã‚¹ (Advice):</strong>
                                                    \${scoreDetails.feedback.improvement || 'No advice'}
                                                </div>
                                            </div>
                                        \` : (scoreDetails.reason ? \`<div class="p-3 bg-blue-50 text-blue-800 text-xs rounded mb-4">\${scoreDetails.reason}</div>\` : '')}
                                        
                                        <table class="w-full text-xs border-collapse">
                                            <thead>
                                                <tr class="bg-slate-50 border-b">
                                                    <th class="p-2 border text-left">è©•ä¾¡é …ç›®</th>
                                                    <th class="p-2 border text-left text-orange-600">I: åŸºç¤</th>
                                                    <th class="p-2 border text-left text-blue-600">C: é–¢é€£</th>
                                                    <th class="p-2 border text-left text-purple-600">E: å¿œç”¨</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                \${gameData.ice.rubricMatrix.map(row => \`
                                                    <tr>
                                                        <td class="p-2 border font-bold bg-slate-50">\${row.category}</td>
                                                        <td class="p-2 border">\${row.i_text}<br><span class="text-[10px] text-slate-400">(max:\${row.i_score})</span> \${getScore(row.category, 'I')}</td>
                                                        <td class="p-2 border">\${row.c_text}<br><span class="text-[10px] text-slate-400">(max:\${row.c_score})</span> \${getScore(row.category, 'C')}</td>
                                                        <td class="p-2 border">\${row.e_text}<br><span class="text-[10px] text-slate-400">(max:\${row.e_score})</span> \${getScore(row.category, 'E')}</td>
                                                    </tr>
                                                \`).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                     \`;
                 }

                 html += \`
                    <div class="h-full bg-slate-900 flex flex-col items-center justify-center p-8 text-center text-white">
                        <div class="mb-6 scale-150 text-\${node.isGood ? 'yellow-400' : 'red-400'}">
                            <i data-lucide="\${node.isGood ? 'award' : 'alert-circle'}" class="w-16 h-16"></i>
                        </div>
                        <h1 class="text-3xl font-bold mb-4">\${node.title}</h1>
                        <p class="text-slate-300 mb-2">\${node.message}</p>
                        <p class="text-2xl font-bold text-yellow-400 mb-8">Score: \${gameScore}</p>
                        
                        <div class="bg-white/10 p-6 rounded-lg w-full text-left">
                            <h3 class="text-xs uppercase tracking-widest text-slate-400 mb-2">Essential Question Review</h3>
                            <div class="text-sm font-bold text-white italic mb-2">"\${gameData.ice.extensions.q || '...'}"</div>
                            <div class="text-xs text-slate-300">Goal: \${gameData.ice.extensions.goal || '...'}</div>
                        </div>

                        \${rubricTable}
                    </div>
                \`;
            }

            html += '</div>';
            root.innerHTML = html;
            lucide.createIcons();
            
            if(node.type === 'chat') {
                const chatContainer = document.getElementById('chat-messages');
                if(chatContainer) chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        // --- HELPER FOR VIRTUAL HOME ---
        function getHomeHTML(node) {
            // Notification Logic
            var notifHTML = '';
            
            // Build Notification if needed
            if (pendingNode) {
                var notifTitle = 'New Notification';
                var notifBody = 'You have a new message';
                var iconType = 'mail';

                if(pendingNode.type === 'email') {
                    notifTitle = pendingNode.sender;
                    notifBody = pendingNode.subject;
                    iconType = 'mail';
                } else if(pendingNode.type === 'chat') {
                    notifTitle = pendingNode.partner;
                    notifBody = 'æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã™';
                    iconType = 'message-circle';
                } else if (pendingNode.type === 'search') {
                    notifTitle = 'Search';
                    notifBody = 'Tap to open search';
                    iconType = 'search';
                }
                
                // Use simple string concatenation to avoid template literal nesting issues
                // Remove onclick from here, as it shouldn't be clickable until shown
                notifHTML = '<div id="home-notif" class="notification" onclick="openApp(\\'' + pendingNode.id + '\\')">' +
                            '<div class="w-10 h-10 bg-indigo-500 rounded-lg flex items-center justify-center text-white"><i data-lucide="' + iconType + '"></i></div>' +
                            '<div>' +
                            '<div class="font-bold text-xs text-slate-900">' + notifTitle + '</div>' +
                            '<div class="text-xs text-slate-500 truncate w-48">' + notifBody + '</div>' +
                            '</div>' +
                            '</div>';
            }

            // Build App Grid HTML safely without nested template literals
            var appsHtml = ['phone', 'message-circle', 'search', 'mail'].map(function(icon) {
                var clickAction = "alert('é€šçŸ¥ãŒã‚ã‚Šã¾ã›ã‚“')";
                var iconId = 'app-icon-' + icon;
                
                // Logic for App Click
                if(pendingNode) {
                    if((icon === 'mail' && pendingNode.type === 'email') ||
                       (icon === 'message-circle' && pendingNode.type === 'chat') ||
                       (icon === 'search' && pendingNode.type === 'search')) {
                        clickAction = "openApp('" + pendingNode.id + "')";
                    }
                } 
                else if (node && node.apps && node.apps.includes(icon)) {
                    if(icon === 'search' && node.next) {
                        clickAction = "triggerNext('" + node.next + "')";
                    }
                }

                var bgClass = "bg-white";
                var textClass = "text-slate-700";

                if(icon === 'phone') { bgClass = "bg-green-500"; textClass = "text-white"; }
                else if(icon === 'message-circle') { bgClass = "bg-green-400"; textClass = "text-white"; }
                else if(icon === 'mail') { bgClass = "bg-blue-500"; textClass = "text-white"; }

                return '<div id="' + iconId + '" class="flex flex-col items-center gap-1 cursor-pointer hover:opacity-80 transition relative" onclick="' + clickAction + '">' +
                       '<div class="w-14 h-14 ' + bgClass + ' rounded-xl flex items-center justify-center shadow-lg">' +
                       '<i data-lucide="' + icon + '" class="w-6 h-6 ' + textClass + '"></i>' +
                       '</div>' +
                       // Badge placeholder container
                       '</div>';
            }).join('');

            return '<div class="h-full w-full bg-gradient-to-br from-indigo-500 to-purple-600 flex flex-col p-4 pt-12 text-white relative">' +
                   notifHTML +
                   '<div class="mt-8 text-center"><h1 class="text-4xl font-light tracking-tighter">' + getFormattedTime() + '</h1><p class="text-sm opacity-80">' + getFormattedDate() + '</p></div>' +
                   '<div class="flex-1"></div>' +
                   '<div class="bg-white/20 backdrop-blur-md rounded-3xl p-4 grid grid-cols-4 gap-4 mb-4">' +
                   appsHtml +
                   '</div>' +
                   '</div>';
        }

        function renderVirtualHome(root) {
            notificationArrived = false; // Reset notification state
            
            root.innerHTML = '<div class="w-full h-full fade-in relative">' + 
                             '<div class="h-6 bg-white/0 absolute w-full top-0 flex justify-between px-4 pt-1 z-50 text-xs font-bold pointer-events-none text-white"><span>' + getFormattedTime() + '</span><span>100%</span></div>' + 
                             getHomeHTML({}) + 
                             '</div>';
            lucide.createIcons();

            // Notification Delay Logic
            if (pendingNode) {
                setTimeout(function() {
                    notificationArrived = true;
                    
                    // Show Notification Banner
                    var notif = document.getElementById('home-notif');
                    if(notif) notif.classList.add('show');
                    
                    // Add Badge to Icon
                    var iconType = 'mail'; // default
                    if(pendingNode.type === 'chat') iconType = 'message-circle';
                    if(pendingNode.type === 'search') iconType = 'search';
                    if(pendingNode.type === 'email') iconType = 'mail';
                    
                    var iconEl = document.getElementById('app-icon-' + iconType);
                    if(iconEl) {
                        var badge = document.createElement('div');
                        badge.className = 'absolute top-0 right-1 w-4 h-4 bg-red-500 rounded-full border-2 border-white fade-in';
                        iconEl.appendChild(badge);
                    }
                }, 3000);
            }
        }

        // Logic Helpers
        function triggerNext(nextId) {
            if(!nextId) return;
            
            const nextNode = gameData.nodes.find(n => n.id === nextId);
            
            // Check for Notification Interception
            if(nextNode && (nextNode.type === 'email' || nextNode.type === 'chat')) {
                pendingNode = nextNode;
                currentNodeId = 'virtual_home';
                render();
                return;
            }

            currentNodeId = nextId;
            render();
        }

        function handleFormSubmit(nextId) {
            alert("é€ä¿¡ã—ã¾ã—ãŸ");
            triggerNext(nextId);
        }

        function handleSearch() {
            const input = document.getElementById('search-input').value;
            const node = gameData.nodes.find(n => n.id === currentNodeId);
            if(input.includes(node.query)) {
                triggerNext(node.next);
            } else {
                alert('æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ’ãƒ³ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }
        
        function startCall() {
            document.getElementById('call-active-ui').classList.remove('hidden');
            const node = gameData.nodes.find(n => n.id === currentNodeId);
            setTimeout(() => triggerNext(node.next), node.duration || 3000);
        }

        async function handleChatSend() {
            const inputEl = document.getElementById('chat-input');
            const text = inputEl.value;
            if(!text) return;

            const node = gameData.nodes.find(n => n.id === currentNodeId);
            
            // Add User Message
            chatHistory.push({sender: 'me', text: text});
            inputEl.value = '';
            render();

            chatCount++;

            // CHECK EXIT CONDITION
            let shouldExit = false;
            if (node.exitCondition === 'keyword' && text.includes(node.exitValue)) shouldExit = true;
            if (node.exitCondition === 'count' && chatCount >= parseInt(node.exitValue || 3)) shouldExit = true;

            if (shouldExit) {
                if (node.chatMode === 'ai' && node.passNext) {
                    // Perform Evaluation
                    await evaluateChat(node);
                } else {
                    setTimeout(() => triggerNext(node.next), 1000);
                }
                return;
            }

            // GENERATE REPLY
            let replyText = "...";

            if (node.chatMode === 'simple') {
                setTimeout(() => triggerNext(node.next), 1000);
                return;
            } 
            else if (node.chatMode === 'rule') {
                const rules = typeof node.rules === 'string' ? JSON.parse(node.rules || '[]') : (node.rules || []);
                const match = rules.find(r => text.includes(r.key));
                replyText = match ? match.res : "ãªã‚‹ã»ã©ã€ä»–ã«ã¯ï¼Ÿ"; 
            } 
            else if (node.chatMode === 'ai') {
                // Gemini API Call
                let key = node.apiKey;
                if(!key) {
                    const userInputKey = document.getElementById('user-api-key');
                    if(userInputKey) key = userInputKey.value;
                }
                
                if(!key) {
                    replyText = "[System] API KeyãŒå¿…è¦ã§ã™ã€‚";
                } else {
                    try {
                        const model = node.modelName || 'gemini-2.5-flash';
                        // Construct System Prompt from ICE data if enabled
                        let sysPrompt = node.systemPrompt || "";
                        if(node.useIcePrompt && gameData.ice) {
                             const ice = gameData.ice;
                             const rubricText = (ice.rubricMatrix || []).map(r => \`- [\${r.category}] I:\${r.i_text}, C:\${r.c_text}, E:\${r.e_text}\`).join('\\n');
                             sysPrompt = \`
                                ã‚ãªãŸã¯ç”Ÿå¾’å½¹ã§ã™ã€‚ä»¥ä¸‹ã®å­¦ç¿’ç›®æ¨™ã«åŸºã¥ã„ã¦å…ˆç”Ÿ(ãƒ¦ãƒ¼ã‚¶ãƒ¼)ã®ç†è§£åº¦ã‚’è©¦ã™è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚
                                I(åŸºç¤):\${ice.ideas.q}, C(é–¢é€£):\${ice.connections.q}, E(å¿œç”¨):\${ice.extensions.q}
                                ãƒ«ãƒ¼ãƒ–ãƒªãƒƒã‚¯:\n\${rubricText}
                                æŒ‡ç¤º: Iãƒ¬ãƒ™ãƒ«ã®è³ªå•ã‹ã‚‰å§‹ã‚ã€å¾ã€…ã«C, Eã¸é€²ã‚“ã§ãã ã•ã„ã€‚ç­”ãˆã¯æ•™ãˆãªã„ã§ãã ã•ã„ã€‚
                                è¿½åŠ æŒ‡ç¤º: \${sysPrompt}
                             \`;
                        }
                        
                        // AUTO-END INSTRUCTION
                        sysPrompt += "\\n\\n[ã‚·ã‚¹ãƒ†ãƒ æŒ‡ç¤º] ä¼šè©±ã®ç›®çš„ãŒé”æˆã•ã‚ŒãŸã€ã¾ãŸã¯è­°è«–ãŒååˆ†ã«å°½ãã•ã‚ŒãŸã¨åˆ¤æ–­ã—ãŸå ´åˆã¯ã€è¿”ç­”ã®æœ€å¾Œã«å¿…ãš [[END]] ã¨ã„ã†æ–‡å­—åˆ—ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚";

                        // Append chat history for context
                        const historyText = chatHistory.map(m => (m.sender === 'me' ? 'Teacher: ' : 'Student: ') + m.text).join('\\n');

                        const response = await fetch(\`https://generativelanguage.googleapis.com/v1beta/models/\${model}:generateContent?key=\${key}\`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [
                                    { role: "user", parts: [{ text: sysPrompt + "\\n\\n[Conversation History]\\n" + historyText + "\\n\\nStudent:" }] }
                                ]
                            })
                        });
                        const data = await response.json();
                        let rawText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Error: No response";
                        
                        // CHECK FOR END SIGNAL
                        if (rawText.includes('[[END]]')) {
                            shouldExit = true;
                            rawText = rawText.replace('[[END]]', '').trim();
                        }
                        replyText = rawText;

                    } catch(e) {
                        replyText = "Error: " + e.message;
                    }
                }
            }

            // Add Reply
            setTimeout(() => {
                chatHistory.push({sender: 'them', text: replyText});
                render();
                
                // Execute Exit if signaled by AI or Condition met
                if (shouldExit) {
                     setTimeout(() => {
                        if (node.chatMode === 'ai' && node.passNext) {
                            evaluateChat(node);
                        } else {
                            triggerNext(node.next);
                        }
                     }, 2000);
                }
            }, 1000);
        }

        async function evaluateChat(node) {
            const loading = document.getElementById('chat-loading');
            if(loading) loading.classList.remove('hidden');

            let key = node.apiKey;
            if(!key) {
                const userInputKey = document.getElementById('user-api-key');
                if(userInputKey) key = userInputKey.value;
            }

            try {
                const model = node.modelName || 'gemini-2.5-flash';
                const ice = gameData.ice;
                // Build rubric details for evaluator
                const rubricDetails = (ice.rubricMatrix || []).map(r => 
                    \`Category: \${r.category} (Max Points: I=\${r.i_score}, C=\${r.c_score}, E=\${r.e_score})\nCriteria: I=\${r.i_text}, C=\${r.c_text}, E=\${r.e_text}\`
                ).join('\\n\\n');

                const historyText = chatHistory.map(m => (m.sender === 'me' ? 'Teacher: ' : 'Student: ') + m.text).join('\\n');

                const evalPrompt = \`
                    ä»¥ä¸‹ã®ä¼šè©±å±¥æ­´ã¨è©•ä¾¡ãƒ«ãƒ¼ãƒ–ãƒªãƒƒã‚¯ã«åŸºã¥ã„ã¦ã€ã€Œå…ˆç”Ÿï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ã€ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚
                    
                    [ä¼šè©±å±¥æ­´]
                    \${historyText}

                    [è©•ä¾¡ãƒ«ãƒ¼ãƒ–ãƒªãƒƒã‚¯]
                    \${rubricDetails}

                    ä»¥ä¸‹ã®æ§‹é€ ã‚’æŒã¤JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã¯ä¸è¦ã§ã™ï¼‰ã€‚
                    å¿…ãšæ—¥æœ¬èªã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
                    {
                        "totalScore": æ•°å€¤ (0-100),
                        "reason": "è©•ä¾¡ã®è¦ç´„ï¼ˆæ—¥æœ¬èªï¼‰",
                        "feedback": {
                            "good": "è‰¯ã‹ã£ãŸç‚¹ï¼ˆæ—¥æœ¬èªã§å…·ä½“çš„ã«ï¼‰",
                            "improvement": "æ”¹å–„ç‚¹ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼ˆæ—¥æœ¬èªã§å…·ä½“çš„ã«ï¼‰"
                        },
                        "details": {
                            "CategoryName1": { "I": score, "C": score, "E": score },
                            "CategoryName2": { "I": score, "C": score, "E": score }
                        }
                    }
                \`;

                const response = await fetch(\`https://generativelanguage.googleapis.com/v1beta/models/\${model}:generateContent?key=\${key}\`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [
                            { role: "user", parts: [{ text: evalPrompt }] }
                        ]
                    })
                });
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                // Parse JSON (handle potential markdown fences)
                const jsonStr = text.replace(/\\\`\\\`\\\`json/g, '').replace(/\\\`\\\`\\\`/g, '').trim();
                const result = JSON.parse(jsonStr);

                gameScore = result.totalScore || 0;
                scoreDetails = result;

                // Determine route
                const threshold = parseInt(node.scoreThreshold) || 60;
                if(gameScore >= threshold) {
                    triggerNext(node.passNext);
                } else {
                    triggerNext(node.failNext);
                }

            } catch(e) {
                console.error("Evaluation failed", e);
                alert("æ¡ç‚¹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ¬¡ã«é€²ã¿ã¾ã™ã€‚");
                triggerNext(node.next); // Fallback
            } finally {
                if(loading) loading.classList.add('hidden');
            }
        }

        window.gameTrigger = function(id) { triggerNext(id); };

        // Start
        window.onload = render;
        `;
        
            return `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>${data.meta.title}</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <script src="https://unpkg.com/lucide@latest"><\/script>
    <style>
        body { background: #0f172a; display: flex; align-items: center; justify-content: center; height: 100vh; font-family: sans-serif; }
        .device-frame { width: 100%; max-width: 400px; height: 100%; max-height: 800px; background: white; position: relative; overflow: hidden; display: flex; flex-col; }
        @media(min-width: 450px) { .device-frame { height: 85vh; border-radius: 24px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); border: 8px solid #334155; } }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .notification { position: absolute; top: 10px; left: 10px; right: 10px; background: rgba(255,255,255,0.95); padding: 10px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); transform: translateY(-150%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 100; display: flex; gap: 10px; backdrop-filter: blur(4px); cursor: pointer; }
        .notification.show { transform: translateY(0); }
    </style>
</head>
<body>
    <div class="device-frame" id="app-root"></div>
    <script>
        ${scriptContent}
    <\/script>
</body>
</html>`;
        }

        // Initialize App
        init();

    </script>
</body>
</html>
