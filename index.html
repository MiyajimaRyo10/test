<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>マーケティング基礎：ペルソナ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background: #0f172a; display: flex; align-items: center; justify-content: center; height: 100vh; font-family: sans-serif; }
        .device-frame { width: 100%; max-width: 400px; height: 100%; max-height: 800px; background: white; position: relative; overflow: hidden; display: flex; flex-col; }
        @media(min-width: 450px) { .device-frame { height: 85vh; border-radius: 24px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); border: 8px solid #334155; } }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .notification { position: absolute; top: 10px; left: 10px; right: 10px; background: rgba(255,255,255,0.95); padding: 10px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); transform: translateY(-150%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 100; display: flex; gap: 10px; backdrop-filter: blur(4px); cursor: pointer; }
        .notification.show { transform: translateY(0); }
    </style>
</head>
<body>
    <div class="device-frame" id="app-root"></div>
    <script>
        
        const gameData = {"meta":{"title":"マーケティング基礎：ペルソナ","author":"EduDesigner"},"goals":{"before":"「ペルソナ」という言葉を曖昧にしか理解していない","after":"ペルソナを定義し、ターゲットとの違いを理解した上で、活用できる"},"storyOutline":"","ice":{"ideas":{"q":"日本の47都道府県はそれぞれどこに位置し、どのような基本的な特徴（県庁所在地、代表的な地理、主要な特産品など）を持っているのか？","goal":"日本の47都道府県の名称と位置を正確に識別し、各都道府県の主要な特徴（県庁所在地、地理的特徴、代表的な産業・特産品など）を具体的に説明できるようになる。"},"connections":{"q":"都道府県を地理的区分、産業、文化などの観点から比較・分類すると、どのような共通点や相違点が見えてくるか？それらの関係性から、日本の地域ごとの特色や繋がりはどのように理解できるか？","goal":"都道府県を複数の視点（例：地理的区分、産業構造、気候、文化）で比較・分類し、共通点や相違点を明確にすることで、地域間の関連性や日本の地域構造について多角的に説明できるようになる。"},"extensions":{"q":"特定の都道府県が抱える社会課題（例：人口減少、地域活性化、環境問題）に対して、その地域の特性を最大限に活かした解決策や、新たな魅力を創造する持続可能なプランをどのように考案できるか？","goal":"特定の都道府県に関する情報を基に、その地域が抱える具体的な課題に対する独創的かつ実現可能な解決策を考案し、または地域の魅力を高めるための新たな持続可能な提案を具体的に企画・説明できるようになる。"},"rubricMatrix":[{"category":"知識・理解","i_text":"47都道府県の名称、位置、県庁所在地を正確に識別し、いくつかの主要な特徴（例：地形、有名産物）を述べることができる。","i_score":10,"c_text":"都道府県を複数の視点（例：地理区分、産業、気候）で分類・比較し、それぞれの共通点や相違点、地域間の関連性を説明できる。","c_score":10,"e_text":"複雑な地域課題や未来の可能性について、複数の都道府県にまたがる知識を統合し、その背景にある地理的・歴史的・文化的要因を深く理解していることを示す。","e_score":10},{"category":"思考力・分析力","i_text":"都道府県に関する基本的な情報を整理し、簡潔に説明できる。","i_score":10,"c_text":"複数の都道府県の情報を比較分析し、その結果を論理的に整理して表現できる。地域間の関係性について自分の考えを述べることができる。","c_score":10,"e_text":"特定の都道府県に関する課題に対し、多様な情報を活用して多角的な解決策を考案し、その妥当性や実現可能性を論理的に説明できる。説得力のある論拠を提示できる。","e_score":10},{"category":"創造性・探究心","i_text":"提示された都道府県の情報を積極的に学び、関心を持つことができる。","i_score":10,"c_text":"既知の情報を超えて、都道府県間の関連性や背景について自ら問いを立て、探究しようとする姿勢が見られる。","c_score":10,"e_text":"都道府県の特性を活かした全く新しいアイデアや、既存の課題に対する独創的な解決策を提案し、その実現に向けて主体的に探究する意欲と姿勢を示す。","e_score":10}]},"onboarding":{"paper1":{"title":"まず初めにこの紙を読んでください","contents":"・学習ガイダンス（本紙）\n・ゲームスタートガイド（QRコード付き）\n・メモ用紙","howToPlay":"1. ストーリーガイド（もう1枚の紙）のQRコードをスマホで読み取ってください。\n2. 架空のスマホ画面が表示されます。指示に従ってアプリを操作してください。\n3. ゲーム内の時間はリアルタイムで進行します。通知が来たら必ず確認してください。\n4. 途中で検索などを行いながら、課題に取り組んでください。"},"paper2":{"title":"ミッション：未来の講師となれ","story":"あなたは「未来進学塾」の採用試験を受けることになった塾講師候補生です。\nこの塾では、単に勉強を教えるだけでなく、生徒の悩みや興味に寄り添う「ペルソナ理解」を最重要視しています。\n\n採用試験の最終課題は、ある一人の生徒との対話を通じて、彼の学習意欲を引き出すこと。\nあなたの指導力が、一人の少年の未来を変えるかもしれません。","role":"未来進学塾のアルバイト講師候補生","action":"お手持ちのスマートフォンで右のQRコードを読み取り、\n未来進学塾の採用サイトへアクセスして応募手続きを行ってください。","qrUrl":"https://example.com/game/start"}},"nodes":[{"id":"n1","type":"os_home","title":"ホーム画面","content":"新しいバイトを探そう。検索アプリを開いてください。","next":"n2","apps":["search","mail","phone","browser"]},{"id":"n2","type":"search","title":"求人検索","query":"未来進学塾 バイト","hint":"「未来進学塾 バイト」で検索してみよう","next":"n3"},{"id":"n3","type":"web","title":"求人サイト","url":"recruit.mirai-juku.edu","html":"<div class='p-4 text-center'><h1 class='text-xl font-bold text-blue-600 mb-2'>未来進学塾</h1><p class='text-sm mb-4'>オンライン講師募集！<br>スキマ時間でOK。</p><button onclick='window.gameTrigger(\"n4\")' class='bg-orange-500 text-white px-6 py-2 rounded-full font-bold shadow hover:bg-orange-600'>応募する</button></div>","next":"n4"},{"id":"n4","type":"form","title":"応募フォーム","fields":[{"label":"氏名","type":"text"},{"label":"志望動機","type":"textarea"}],"submitText":"送信する","next":"n5"},{"id":"n5","type":"delay","title":"待機(審査中)","duration":3000,"next":"n6"},{"id":"n6","type":"email","title":"採用メール","sender":"hr@mirai-juku.edu","subject":"【採用通知】一次審査通過","body":"ご応募ありがとうございます。\n一次審査を通過されました。\n\n最終確認のため、以下の番号へ電話連絡をお願いします。","linkText":"塾長に電話する","next":"n7"},{"id":"n7","type":"phone","title":"通話: 塾長","caller":"未来進学塾 塾長","audio":"voice_dummy","duration":6000,"script":"電話ありがとう。この生徒の担当をしてほしい。基本チャットでのお仕事だからお願いね！チャット教えとくから、生徒から質問があったら送ってね。","next":"n8"},{"id":"n8","type":"email","title":"業務連絡","sender":"manager@mirai-juku.edu","subject":"担当生徒について","body":"担当してもらう「ケンタ君」のチャットルームです。\n質問が来ているようなので、対応お願いします。","linkText":"チャットルームへ移動","next":"n9"},{"id":"n9","type":"chat","title":"指導チャット (ペルソナ)","partner":"ケンタ(生徒)","chatMode":"ai","modelName":"gemini-2.5-flash","useIcePrompt":true,"systemPrompt":"あなたは好奇心旺盛な男子高校生「ケンタ」です。マーケティングに少し興味があります。\n口調はフランクで、「〜っすね」「マジで？」などが口癖です。\n\n以下の順序で先生（ユーザー）に質問し、理解を深めてください。\n1. 【導入】昨日友達に「ペルソナ」ってすごいよなって言われたけど、ゲームのこと？それとも心理学？まずは「定義」を聞く。\n2. 【深掘り】「ターゲット」と何が違うのか疑問を持つ。「20代男性」とかじゃダメなの？と聞く。\n3. 【応用】もし文化祭でタピオカ屋をやるなら、どんなペルソナにすればいいか相談する。\n\n納得したら「なるほど！めっちゃわかった！」と言ってください。","apiKey":"","exitCondition":"count","exitValue":5,"scoreThreshold":40,"passNext":"end_good","failNext":"end_bad","initialImage":"https://placehold.co/600x400/e2e8f0/64748b?text=Note+Image","messages":[{"sender":"them","text":"先生！昨日友達に「これからはペルソナが大事だ」って言われたんですけど、ペルソナってあのゲームのことっすか？なにそれ？"}]},{"id":"end_good","type":"result","title":"Mission Complete","isGood":true,"message":"ケンタはペルソナの重要性を完全に理解しました！文化祭も成功しそうです。"},{"id":"end_bad","type":"result","title":"Mission Failed","isGood":false,"message":"ケンタは混乱しています。「ターゲットで良くない？」と言い残して去っていきました..."}]};
        let currentNodeId = gameData.nodes[0].id;
        let chatHistory = [];
        let chatCount = 0;
        let gameScore = 0;
        let scoreDetails = {};
        let pendingNode = null; // For Notification Wait
        let notificationArrived = false;
        
        // --- GAME ENGINE ---
        
        // Global App Opener
        window.openApp = function(nodeId) {
            if(!nodeId) {
                alert('アプリが開けません');
                return;
            }
            
            // 通知待ち状態で、まだ通知が来ていない場合は反応しない
            if (pendingNode && pendingNode.id === nodeId && !notificationArrived) {
                return; 
            }
            
            pendingNode = null; 
            notificationArrived = false;
            currentNodeId = nodeId; // 直接遷移
            render();
        };

        // Date Format Helper
        function getFormattedTime() {
            const now = new Date();
            return now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        }
        function getFormattedDate() {
            const now = new Date();
            return now.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
        }

        function render() {
            const root = document.getElementById('app-root');
            
            // Virtual Home State (Waiting for app open)
            if(currentNodeId === 'virtual_home') {
                renderVirtualHome(root);
                return;
            }

            const node = gameData.nodes.find(n => n.id === currentNodeId);
            if(!node) return root.innerHTML = '<div class="p-10">Error: Node not found</div>';

            // Reset chat history when entering new chat node
            if(node.type === 'chat' && chatHistory.length === 0) {
                 if(node.messages && node.messages[0] && node.messages[0].text) {
                     chatHistory.push({sender: 'them', text: node.messages[0].text});
                 }
                 if(node.initialImage) {
                     chatHistory.push({sender: 'them', image: node.initialImage});
                 }
                 chatCount = 0;
            } else if (node.type !== 'chat') {
                chatHistory = [];
            }

            let html = '';
            // Status Bar with Realtime Clock
            const timeStr = getFormattedTime();
            
            html += '<div class="h-6 bg-white/0 absolute w-full top-0 flex justify-between px-4 pt-1 z-50 text-xs font-bold pointer-events-none ' + (node.type === 'os_home' ? 'text-white' : 'text-slate-800') + '"><span>' + timeStr + '</span><span>100%</span></div>';

            // Main Content Area
            html += '<div class="w-full h-full fade-in relative">';
            
            if(node.type === 'os_home') {
                html += getHomeHTML(node);
            } 
            else if(node.type === 'search') {
                html += `
                    <div class="bg-white h-full flex flex-col pt-12 px-6">
                        <div class="text-center mb-8"><span class="text-4xl font-bold text-slate-700"><span class="text-blue-500">G</span>oogle</span></div>
                        <input type="text" id="search-input" class="w-full border border-slate-300 rounded-full py-3 px-5 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="検索...">
                        <button onclick="handleSearch()" class="mt-4 bg-slate-100 text-slate-600 px-6 py-2 rounded text-sm mx-auto hover:bg-slate-200">Google 検索</button>
                        <div class="mt-10 p-4 bg-yellow-50 text-yellow-800 text-xs rounded border border-yellow-100">Hint: ${node.hint}</div>
                    </div>
                `;
            }
            else if(node.type === 'web') {
                html += `
                    <div class="bg-white h-full flex flex-col pt-8">
                        <div class="bg-slate-100 border-b p-2 flex items-center gap-2 text-xs text-slate-500 px-4">
                            <i data-lucide="lock" class="w-3 h-3"></i> <div class="bg-white px-2 py-1 rounded flex-1">${node.url}</div>
                        </div>
                        <div class="flex-1 overflow-y-auto relative">
                            ${node.html}
                        </div>
                    </div>
                `;
            }
            else if(node.type === 'form') {
                html += `
                    <div class="bg-white h-full flex flex-col pt-8 overflow-y-auto">
                        <div class="bg-slate-800 text-white p-4"><h2 class="font-bold">応募フォーム</h2></div>
                        <div class="p-6 space-y-4">
                            <div><label class="text-xs font-bold text-slate-500">氏名</label><input type="text" class="w-full border p-2 rounded"></div>
                            <div><label class="text-xs font-bold text-slate-500">志望動機</label><textarea class="w-full border p-2 rounded h-24"></textarea></div>
                            <button onclick="handleFormSubmit('${node.next}')" class="w-full bg-orange-500 text-white font-bold py-3 rounded-lg shadow mt-4 hover:bg-orange-600">${node.submitText}</button>
                        </div>
                    </div>
                `;
            }
            else if(node.type === 'delay') {
                 html += `<div class="h-full bg-black flex items-center justify-center"><div class="w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin"></div></div>`;
                 setTimeout(() => triggerNext(node.next), node.duration || 2000);
            }
            else if(node.type === 'phone') {
                html += `
                    <div class="bg-slate-900 h-full flex flex-col items-center pt-24 text-white">
                        <div class="animate-pulse mb-4 text-slate-300 text-sm">着信中...</div>
                        <div class="w-24 h-24 rounded-full bg-slate-700 flex items-center justify-center mb-6">
                            <i data-lucide="user" class="w-12 h-12 text-slate-400"></i>
                        </div>
                        <h2 class="text-3xl font-light mb-2">${node.caller}</h2>
                        
                        <div class="absolute bottom-20 w-full flex justify-around px-12">
                             <div class="flex flex-col items-center gap-2" onclick="startCall()">
                                <div class="w-16 h-16 rounded-full bg-green-500 flex items-center justify-center animate-bounce cursor-pointer">
                                    <i data-lucide="phone" class="w-8 h-8"></i>
                                </div>
                                <span class="text-xs">応答</span>
                            </div>
                        </div>
                        <div id="call-active-ui" class="hidden absolute inset-0 bg-slate-800 flex flex-col items-center justify-center z-20">
                            <div class="text-green-400 mb-4">通話中 00:01</div>
                            <div class="px-8 text-center text-slate-300 italic">"${node.script}"</div>
                        </div>
                    </div>
                `;
            }
            else if(node.type === 'email') {
                html += `
                    <div class="bg-white h-full flex flex-col pt-8">
                        <div class="bg-slate-50 border-b p-4 flex justify-between items-center">
                            <span class="text-blue-600 font-bold" onclick="alert('戻れません')">＜ 受信箱</span>
                        </div>
                        <div class="p-5">
                            <h1 class="font-bold text-lg mb-4">${node.subject}</h1>
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold">${node.sender[0]}</div>
                                <div><div class="text-sm font-bold">${node.sender}</div><div class="text-xs text-slate-400">To: 自分</div></div>
                            </div>
                            <div class="text-slate-800 leading-relaxed whitespace-pre-wrap text-sm">${node.body}</div>
                            ${node.linkText ? `<button onclick="triggerNext('${node.next}')" class="mt-8 w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow hover:bg-blue-700">${node.linkText}</button>` : ''}
                        </div>
                    </div>
                `;
            }
             else if(node.type === 'video') {
                html += `
                    <div class="bg-slate-900 h-full relative">
                         <img src="${node.image}" class="w-full h-full object-cover opacity-80">
                         <div class="absolute bottom-0 w-full h-40 bg-gradient-to-t from-black/90 to-transparent p-6">
                            <div class="text-white font-bold text-lg mb-1">${node.streamName}</div>
                             <div class="text-white/80 text-sm italic mb-4">"${node.script}"</div>
                             <div class="flex gap-4 justify-center">
                                <button class="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center text-white"><i data-lucide="mic-off"></i></button>
                                <button class="w-12 h-12 rounded-full bg-red-600 flex items-center justify-center text-white" onclick="triggerNext('${node.next}')"><i data-lucide="phone-off"></i></button>
                             </div>
                         </div>
                    </div>
                `;
            }
             else if(node.type === 'chat') {
                 // Enhanced Chat
                 const apiKeyField = node.chatMode === 'ai' && !node.apiKey ? '<div class="px-4 py-2 bg-yellow-50 text-xs text-yellow-700 mb-2">API Key Required</div><input type="password" id="user-api-key" placeholder="Gemini API Key" class="w-full border p-2 mb-2 rounded text-xs">' : '';
                 const forceEndBtn = node.chatMode === 'ai' ? '<button onclick="evaluateChat(gameData.nodes.find(n => n.id === currentNodeId))" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded ml-auto">会話終了</button>' : '';

                 const bubblesHtml = chatHistory.map(m => {
                    let content = '';
                    if(m.image) {
                         return `
                            <div class="flex gap-2 ${m.sender === 'me' ? 'flex-row-reverse' : ''} mb-2">
                                <div class="w-8 h-8 rounded-full ${m.sender === 'me' ? 'bg-indigo-500' : 'bg-slate-300'} flex-shrink-0"></div>
                                <div class="p-2 rounded-lg shadow-sm text-sm max-w-[80%] bg-white rounded-tl-none">
                                    <img src="${m.image}" class="rounded-lg max-w-full h-auto border border-slate-200">
                                </div>
                            </div>
                        `;
                    } else if (m.text) {
                        // Split text by newline
                        const lines = m.text.split('\n');
                        return lines.map(line => {
                             if(!line.trim()) return '';
                             return `
                                <div class="flex gap-2 ${m.sender === 'me' ? 'flex-row-reverse' : ''} mb-1">
                                    <div class="w-8 h-8 rounded-full ${m.sender === 'me' ? 'bg-indigo-500' : 'bg-slate-300'} flex-shrink-0"></div>
                                    <div class="p-3 rounded-lg shadow-sm text-sm max-w-[80%] ${m.sender === 'me' ? 'bg-indigo-500 text-white rounded-tr-none' : 'bg-white rounded-tl-none'}">${line}</div>
                                </div>
                            `;
                        }).join('');
                    }
                    return '';
                 }).join('');

                html += `
                    <div class="bg-slate-100 h-full flex flex-col pt-10">
                         <div class="bg-white p-3 shadow-sm flex items-center gap-2 z-10">
                            <i data-lucide="arrow-left" class="w-5 h-5 text-blue-500"></i> 
                            <span class="font-bold">${node.partner}</span>
                            ${forceEndBtn}
                         </div>
                         
                         <div id="chat-messages" class="flex-1 p-4 overflow-y-auto pb-20">
                             ${apiKeyField}
                             ${bubblesHtml}
                         </div>

                         <div class="p-3 bg-white border-t flex gap-2 fixed bottom-0 w-full max-w-[400px]">
                            <input type="text" id="chat-input" class="flex-1 border rounded-full px-4 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="メッセージを入力">
                            <button onclick="handleChatSend()" class="bg-blue-500 text-white rounded-full p-2 hover:bg-blue-600"><i data-lucide="send" class="w-4 h-4"></i></button>
                         </div>
                         <div id="chat-loading" class="hidden absolute inset-0 bg-black/20 z-50 flex items-center justify-center">
                            <div class="bg-white p-4 rounded shadow-lg text-xs font-bold flex items-center gap-2"><div class="w-4 h-4 border-2 border-blue-500 rounded-full animate-spin border-t-transparent"></div>採点中...</div>
                         </div>
                    </div>
                `;
            }
            else if(node.type === 'result') {
                 // Rubric Table Generation
                 let rubricTable = '';
                 if(gameData.ice && gameData.ice.rubricMatrix && gameData.ice.rubricMatrix.length > 0) {
                     // Inject score details if available
                     const getScore = (cat, type) => {
                         if(scoreDetails && scoreDetails.details && scoreDetails.details[cat] && scoreDetails.details[cat][type]) {
                             return '<span class="text-red-500 font-bold ml-1">(' + scoreDetails.details[cat][type] + '点)</span>';
                         }
                         return '';
                     }

                     rubricTable = `
                        <div class="mt-6 w-full max-w-sm">
                            <button onclick="document.getElementById('rubric-modal').classList.remove('hidden')" class="w-full bg-white/20 hover:bg-white/30 text-white py-2 rounded text-sm font-bold border border-white/40 flex items-center justify-center gap-2">
                                <i data-lucide="table"></i> 評価ルーブリックを確認
                            </button>
                            
                            <!-- Rubric Modal -->
                            <div id="rubric-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                                <div class="bg-white text-slate-800 rounded-lg w-full max-w-lg max-h-[80vh] overflow-y-auto relative">
                                    <div class="sticky top-0 bg-white border-b p-4 flex justify-between items-center">
                                        <h3 class="font-bold text-lg">学習評価ルーブリック (合計: ${gameScore}点)</h3>
                                        <button onclick="document.getElementById('rubric-modal').classList.add('hidden')" class="p-1 hover:bg-slate-100 rounded"><i data-lucide="x" class="text-slate-500"></i></button>
                                    </div>
                                    <div class="p-4">
                                        ${scoreDetails.feedback ? `
                                            <div class="mb-4 space-y-2">
                                                <div class="p-3 bg-green-50 border border-green-100 rounded text-xs">
                                                    <strong class="text-green-700 block mb-1">良かった点 (Good Points):</strong>
                                                    ${scoreDetails.feedback.good || 'No feedback'}
                                                </div>
                                                <div class="p-3 bg-orange-50 border border-orange-100 rounded text-xs">
                                                    <strong class="text-orange-700 block mb-1">アドバイス (Advice):</strong>
                                                    ${scoreDetails.feedback.improvement || 'No advice'}
                                                </div>
                                            </div>
                                        ` : (scoreDetails.reason ? `<div class="p-3 bg-blue-50 text-blue-800 text-xs rounded mb-4">${scoreDetails.reason}</div>` : '')}
                                        
                                        <table class="w-full text-xs border-collapse">
                                            <thead>
                                                <tr class="bg-slate-50 border-b">
                                                    <th class="p-2 border text-left">評価項目</th>
                                                    <th class="p-2 border text-left text-orange-600">I: 基礎</th>
                                                    <th class="p-2 border text-left text-blue-600">C: 関連</th>
                                                    <th class="p-2 border text-left text-purple-600">E: 応用</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${gameData.ice.rubricMatrix.map(row => `
                                                    <tr>
                                                        <td class="p-2 border font-bold bg-slate-50">${row.category}</td>
                                                        <td class="p-2 border">${row.i_text}<br><span class="text-[10px] text-slate-400">(max:${row.i_score})</span> ${getScore(row.category, 'I')}</td>
                                                        <td class="p-2 border">${row.c_text}<br><span class="text-[10px] text-slate-400">(max:${row.c_score})</span> ${getScore(row.category, 'C')}</td>
                                                        <td class="p-2 border">${row.e_text}<br><span class="text-[10px] text-slate-400">(max:${row.e_score})</span> ${getScore(row.category, 'E')}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                     `;
                 }

                 html += `
                    <div class="h-full bg-slate-900 flex flex-col items-center justify-center p-8 text-center text-white">
                        <div class="mb-6 scale-150 text-${node.isGood ? 'yellow-400' : 'red-400'}">
                            <i data-lucide="${node.isGood ? 'award' : 'alert-circle'}" class="w-16 h-16"></i>
                        </div>
                        <h1 class="text-3xl font-bold mb-4">${node.title}</h1>
                        <p class="text-slate-300 mb-2">${node.message}</p>
                        <p class="text-2xl font-bold text-yellow-400 mb-8">Score: ${gameScore}</p>
                        
                        <div class="bg-white/10 p-6 rounded-lg w-full text-left">
                            <h3 class="text-xs uppercase tracking-widest text-slate-400 mb-2">Essential Question Review</h3>
                            <div class="text-sm font-bold text-white italic mb-2">"${gameData.ice.extensions.q || '...'}"</div>
                            <div class="text-xs text-slate-300">Goal: ${gameData.ice.extensions.goal || '...'}</div>
                        </div>

                        ${rubricTable}
                    </div>
                `;
            }

            html += '</div>';
            root.innerHTML = html;
            lucide.createIcons();
            
            if(node.type === 'chat') {
                const chatContainer = document.getElementById('chat-messages');
                if(chatContainer) chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        // --- HELPER FOR VIRTUAL HOME ---
        function getHomeHTML(node) {
            // Notification Logic
            var notifHTML = '';
            
            // Build Notification if needed
            if (pendingNode) {
                var notifTitle = 'New Notification';
                var notifBody = 'You have a new message';
                var iconType = 'mail';

                if(pendingNode.type === 'email') {
                    notifTitle = pendingNode.sender;
                    notifBody = pendingNode.subject;
                    iconType = 'mail';
                } else if(pendingNode.type === 'chat') {
                    notifTitle = pendingNode.partner;
                    notifBody = '新着メッセージがあります';
                    iconType = 'message-circle';
                } else if (pendingNode.type === 'search') {
                    notifTitle = 'Search';
                    notifBody = 'Tap to open search';
                    iconType = 'search';
                }
                
                // Use simple string concatenation to avoid template literal nesting issues
                // Remove onclick from here, as it shouldn't be clickable until shown
                notifHTML = '<div id="home-notif" class="notification" onclick="openApp(\'' + pendingNode.id + '\')">' +
                            '<div class="w-10 h-10 bg-indigo-500 rounded-lg flex items-center justify-center text-white"><i data-lucide="' + iconType + '"></i></div>' +
                            '<div>' +
                            '<div class="font-bold text-xs text-slate-900">' + notifTitle + '</div>' +
                            '<div class="text-xs text-slate-500 truncate w-48">' + notifBody + '</div>' +
                            '</div>' +
                            '</div>';
            }

            // Build App Grid HTML safely without nested template literals
            var appsHtml = ['phone', 'message-circle', 'search', 'mail'].map(function(icon) {
                var clickAction = "alert('通知がありません')";
                var iconId = 'app-icon-' + icon;
                
                // Logic for App Click
                if(pendingNode) {
                    if((icon === 'mail' && pendingNode.type === 'email') ||
                       (icon === 'message-circle' && pendingNode.type === 'chat') ||
                       (icon === 'search' && pendingNode.type === 'search')) {
                        clickAction = "openApp('" + pendingNode.id + "')";
                    }
                } 
                else if (node && node.apps && node.apps.includes(icon)) {
                    if(icon === 'search' && node.next) {
                        clickAction = "triggerNext('" + node.next + "')";
                    }
                }

                var bgClass = "bg-white";
                var textClass = "text-slate-700";

                if(icon === 'phone') { bgClass = "bg-green-500"; textClass = "text-white"; }
                else if(icon === 'message-circle') { bgClass = "bg-green-400"; textClass = "text-white"; }
                else if(icon === 'mail') { bgClass = "bg-blue-500"; textClass = "text-white"; }

                return '<div id="' + iconId + '" class="flex flex-col items-center gap-1 cursor-pointer hover:opacity-80 transition relative" onclick="' + clickAction + '">' +
                       '<div class="w-14 h-14 ' + bgClass + ' rounded-xl flex items-center justify-center shadow-lg">' +
                       '<i data-lucide="' + icon + '" class="w-6 h-6 ' + textClass + '"></i>' +
                       '</div>' +
                       // Badge placeholder container
                       '</div>';
            }).join('');

            return '<div class="h-full w-full bg-gradient-to-br from-indigo-500 to-purple-600 flex flex-col p-4 pt-12 text-white relative">' +
                   notifHTML +
                   '<div class="mt-8 text-center"><h1 class="text-4xl font-light tracking-tighter">' + getFormattedTime() + '</h1><p class="text-sm opacity-80">' + getFormattedDate() + '</p></div>' +
                   '<div class="flex-1"></div>' +
                   '<div class="bg-white/20 backdrop-blur-md rounded-3xl p-4 grid grid-cols-4 gap-4 mb-4">' +
                   appsHtml +
                   '</div>' +
                   '</div>';
        }

        function renderVirtualHome(root) {
            notificationArrived = false; // Reset notification state
            
            root.innerHTML = '<div class="w-full h-full fade-in relative">' + 
                             '<div class="h-6 bg-white/0 absolute w-full top-0 flex justify-between px-4 pt-1 z-50 text-xs font-bold pointer-events-none text-white"><span>' + getFormattedTime() + '</span><span>100%</span></div>' + 
                             getHomeHTML({}) + 
                             '</div>';
            lucide.createIcons();

            // Notification Delay Logic
            if (pendingNode) {
                setTimeout(function() {
                    notificationArrived = true;
                    
                    // Show Notification Banner
                    var notif = document.getElementById('home-notif');
                    if(notif) notif.classList.add('show');
                    
                    // Add Badge to Icon
                    var iconType = 'mail'; // default
                    if(pendingNode.type === 'chat') iconType = 'message-circle';
                    if(pendingNode.type === 'search') iconType = 'search';
                    if(pendingNode.type === 'email') iconType = 'mail';
                    
                    var iconEl = document.getElementById('app-icon-' + iconType);
                    if(iconEl) {
                        var badge = document.createElement('div');
                        badge.className = 'absolute top-0 right-1 w-4 h-4 bg-red-500 rounded-full border-2 border-white fade-in';
                        iconEl.appendChild(badge);
                    }
                }, 3000);
            }
        }

        // Logic Helpers
        function triggerNext(nextId) {
            if(!nextId) return;
            
            const nextNode = gameData.nodes.find(n => n.id === nextId);
            
            // Check for Notification Interception
            if(nextNode && (nextNode.type === 'email' || nextNode.type === 'chat')) {
                pendingNode = nextNode;
                currentNodeId = 'virtual_home';
                render();
                return;
            }

            currentNodeId = nextId;
            render();
        }

        function handleFormSubmit(nextId) {
            alert("送信しました");
            triggerNext(nextId);
        }

        function handleSearch() {
            const input = document.getElementById('search-input').value;
            const node = gameData.nodes.find(n => n.id === currentNodeId);
            if(input.includes(node.query)) {
                triggerNext(node.next);
            } else {
                alert('検索結果が見つかりません。ヒントを確認してください。');
            }
        }
        
        function startCall() {
            document.getElementById('call-active-ui').classList.remove('hidden');
            const node = gameData.nodes.find(n => n.id === currentNodeId);
            setTimeout(() => triggerNext(node.next), node.duration || 3000);
        }

        async function handleChatSend() {
            const inputEl = document.getElementById('chat-input');
            const text = inputEl.value;
            if(!text) return;

            const node = gameData.nodes.find(n => n.id === currentNodeId);
            
            // Add User Message
            chatHistory.push({sender: 'me', text: text});
            inputEl.value = '';
            render();

            chatCount++;

            // CHECK EXIT CONDITION
            let shouldExit = false;
            if (node.exitCondition === 'keyword' && text.includes(node.exitValue)) shouldExit = true;
            if (node.exitCondition === 'count' && chatCount >= parseInt(node.exitValue || 3)) shouldExit = true;

            if (shouldExit) {
                if (node.chatMode === 'ai' && node.passNext) {
                    // Perform Evaluation
                    await evaluateChat(node);
                } else {
                    setTimeout(() => triggerNext(node.next), 1000);
                }
                return;
            }

            // GENERATE REPLY
            let replyText = "...";

            if (node.chatMode === 'simple') {
                setTimeout(() => triggerNext(node.next), 1000);
                return;
            } 
            else if (node.chatMode === 'rule') {
                const rules = typeof node.rules === 'string' ? JSON.parse(node.rules || '[]') : (node.rules || []);
                const match = rules.find(r => text.includes(r.key));
                replyText = match ? match.res : "なるほど、他には？"; 
            } 
            else if (node.chatMode === 'ai') {
                // Gemini API Call
                let key = node.apiKey;
                if(!key) {
                    const userInputKey = document.getElementById('user-api-key');
                    if(userInputKey) key = userInputKey.value;
                }
                
                if(!key) {
                    replyText = "[System] API Keyが必要です。";
                } else {
                    try {
                        const model = node.modelName || 'gemini-2.5-flash';
                        // Construct System Prompt from ICE data if enabled
                        let sysPrompt = node.systemPrompt || "";
                        if(node.useIcePrompt && gameData.ice) {
                             const ice = gameData.ice;
                             const rubricText = (ice.rubricMatrix || []).map(r => `- [${r.category}] I:${r.i_text}, C:${r.c_text}, E:${r.e_text}`).join('\n');
                             sysPrompt = `
                                あなたは生徒役です。以下の学習目標に基づいて先生(ユーザー)の理解度を試す質問をしてください。
                                I(基礎):${ice.ideas.q}, C(関連):${ice.connections.q}, E(応用):${ice.extensions.q}
                                ルーブリック:
${rubricText}
                                指示: Iレベルの質問から始め、徐々にC, Eへ進んでください。答えは教えないでください。
                                追加指示: ${sysPrompt}
                             `;
                        }
                        
                        // AUTO-END INSTRUCTION
                        sysPrompt += "\n\n[システム指示] 会話の目的が達成された、または議論が十分に尽くされたと判断した場合は、返答の最後に必ず [[END]] という文字列をつけてください。";

                        // Append chat history for context
                        const historyText = chatHistory.map(m => (m.sender === 'me' ? 'Teacher: ' : 'Student: ') + m.text).join('\n');

                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [
                                    { role: "user", parts: [{ text: sysPrompt + "\n\n[Conversation History]\n" + historyText + "\n\nStudent:" }] }
                                ]
                            })
                        });
                        const data = await response.json();
                        let rawText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Error: No response";
                        
                        // CHECK FOR END SIGNAL
                        if (rawText.includes('[[END]]')) {
                            shouldExit = true;
                            rawText = rawText.replace('[[END]]', '').trim();
                        }
                        replyText = rawText;

                    } catch(e) {
                        replyText = "Error: " + e.message;
                    }
                }
            }

            // Add Reply
            setTimeout(() => {
                chatHistory.push({sender: 'them', text: replyText});
                render();
                
                // Execute Exit if signaled by AI or Condition met
                if (shouldExit) {
                     setTimeout(() => {
                        if (node.chatMode === 'ai' && node.passNext) {
                            evaluateChat(node);
                        } else {
                            triggerNext(node.next);
                        }
                     }, 2000);
                }
            }, 1000);
        }

        async function evaluateChat(node) {
            const loading = document.getElementById('chat-loading');
            if(loading) loading.classList.remove('hidden');

            let key = node.apiKey;
            if(!key) {
                const userInputKey = document.getElementById('user-api-key');
                if(userInputKey) key = userInputKey.value;
            }

            try {
                const model = node.modelName || 'gemini-2.5-flash';
                const ice = gameData.ice;
                // Build rubric details for evaluator
                const rubricDetails = (ice.rubricMatrix || []).map(r => 
                    `Category: ${r.category} (Max Points: I=${r.i_score}, C=${r.c_score}, E=${r.e_score})
Criteria: I=${r.i_text}, C=${r.c_text}, E=${r.e_text}`
                ).join('\n\n');

                const historyText = chatHistory.map(m => (m.sender === 'me' ? 'Teacher: ' : 'Student: ') + m.text).join('\n');

                const evalPrompt = `
                    以下の会話履歴と評価ルーブリックに基づいて、「先生（ユーザー）」のパフォーマンスを評価してください。
                    
                    [会話履歴]
                    ${historyText}

                    [評価ルーブリック]
                    ${rubricDetails}

                    以下の構造を持つJSONオブジェクトのみを出力してください（マークダウンは不要です）。
                    必ず日本語で出力してください。
                    {
                        "totalScore": 数値 (0-100),
                        "reason": "評価の要約（日本語）",
                        "feedback": {
                            "good": "良かった点（日本語で具体的に）",
                            "improvement": "改善点とアドバイス（日本語で具体的に）"
                        },
                        "details": {
                            "CategoryName1": { "I": score, "C": score, "E": score },
                            "CategoryName2": { "I": score, "C": score, "E": score }
                        }
                    }
                `;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [
                            { role: "user", parts: [{ text: evalPrompt }] }
                        ]
                    })
                });
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                // Parse JSON (handle potential markdown fences)
                const jsonStr = text.replace(/\`\`\`json/g, '').replace(/\`\`\`/g, '').trim();
                const result = JSON.parse(jsonStr);

                gameScore = result.totalScore || 0;
                scoreDetails = result;

                // Determine route
                const threshold = parseInt(node.scoreThreshold) || 60;
                if(gameScore >= threshold) {
                    triggerNext(node.passNext);
                } else {
                    triggerNext(node.failNext);
                }

            } catch(e) {
                console.error("Evaluation failed", e);
                alert("採点エラーが発生しました。次に進みます。");
                triggerNext(node.next); // Fallback
            } finally {
                if(loading) loading.classList.add('hidden');
            }
        }

        window.gameTrigger = function(id) { triggerNext(id); };

        // Start
        window.onload = render;
        
    </script>
</body>
</html>
